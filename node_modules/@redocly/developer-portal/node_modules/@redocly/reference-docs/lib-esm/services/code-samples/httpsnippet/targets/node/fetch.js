import{__assign}from"tslib";import stringifyObject from"stringify-object";import{CodeBuilder}from"../../helpers/code-builder";import{addIndentation,getPreserveTransformer,parseUrlIntoOperands}from"../../helpers/code-helpers";import{Lang,VariableType}from"../../helpers/constants";import{normalizeMimeType}from"../../../../utils";import{HTTPSnippet}from"../..";var printPathVariablesCodeLines=function(e,a){var t=e.pathParameters;return Object.keys(t).forEach((function(e){var r=t[e]||"YOUR_"+e+"_PARAMETER";a.push("const "+a.var(e,VariableType.PATH)+" = '%s';",r)}))};function getUrl(e,a){var t=e.url,r=void 0===t?"":t,n=e.pathParameters;return parseUrlIntoOperands(r,void 0===n?{}:n).map((function(e){return"variable"===e.type?"${"+a.var(e.name,VariableType.PATH)+"}":e.value})).join("")}var handler=function(e,a,t){var r,n,i,o,s,p=t.target,d=t.client,l=Object.assign({indent:"  "},a),h=!1,m=new CodeBuilder({indentation:l.indent,variablesPrefix:l.variablesPrefix,capitalize:!0,lang:Lang.NODEJS});l.withComments&&addComments(m),l.withImports&&(m.push("const fetch = require('node-fetch');"),m.blank());var c={method:e.method.toUpperCase()};Object.keys(e.headersObj).length&&(c.headers=e.headersObj);var u=!1;if(null===(r=e.securityOAuth2ExtraCalls)||void 0===r?void 0:r.length){var f=new HTTPSnippet(null===(n=e.securityOAuth2ExtraCalls)||void 0===n?void 0:n[0]).convert(p,d,__assign(__assign({},l),{withImports:!1,withComments:!1,variablesPrefix:"oAuth2"}));m.push(f),m.blank(),c.headers=c.headers||{},c.headers.Authorization="'Bearer ' + oAuth2Data.access_token",u=!0}var v=Object.getOwnPropertyNames(e.queryObj).length;if(v&&m.push("const "+m.var("query")+" = new URLSearchParams("+stringifyObject(e.queryObj,{indent:l.indent,inlineCharacterLimit:25})+").toString();").blank(),e.postData)switch(normalizeMimeType(e.postData.mimeType)){case"application/x-www-form-urlencoded":c.body=e.postData.paramsObj?"new URLSearchParams("+m.var("formData")+").toString()":e.postData.text,e.postData.paramsObj&&m.push("const "+m.var("formData")+" = "+addIndentation(stringifyObject(e.postData.paramsObj,{indent:l.indent,inlineCharacterLimit:25}),{level:0,firstLine:!1})+";").blank();break;case"application/json":e.postData.jsonObj&&(c.body="JSON.stringify("+addIndentation(stringifyObject(e.postData.jsonObj,{indent:l.indent,inlineCharacterLimit:25}),{level:1,firstLine:!1})+")");break;case"multipart/form-data":(null===(i=null==c?void 0:c.headers)||void 0===i?void 0:i["Content-Type"])&&(null===(o=c.headers)||void 0===o||delete o["Content-Type"]),l.withImports&&m.unshift("const FormData = require('form-data');"),m.push("const "+m.var("form")+" = new FormData();"),e.postData.params.forEach((function(e){e.fileName||e.fileName||e.contentType?e.fileName&&(h=!0,m.blank(),m.push(m.var("form")+".append('\" + param.name + \"', fs.createReadStream('\" + param.fileName + \"'));")):m.push("form.append('"+e.name+"','"+e.value+"');")})),c.body=m.var("form"),m.blank();break;default:e.postData.text&&(c.body="`"+addIndentation(e.postData.text,{level:2,indent:l.indent,firstLine:!1}).trim()+"`")}if(e.cookies.length){var b="";e.cookies.forEach((function(e){b=b+encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)+"; "})),b=b.trim(),c.headers||(c.headers={}),c.headers.cookie=b}e.basicAuth&&(c.headers=c.headers||{},c.headers.Authorization="'Basic ' + Buffer.from('<username>:<password>').toString('base64')",u=!0),h&&l.withImports&&m.unshift("const fs = require('fs');");var y=c.headers&&c.headers.Accept&&"application/json"===normalizeMimeType(c.headers.Accept)||"application/json"===normalizeMimeType(null===(s=e.postData)||void 0===s?void 0:s.mimeType);return printPathVariablesCodeLines(e,m),m.push("const "+m.var("resp")+" = await fetch(").push(1,"`"+getUrl(e,m)+(v?"?${"+m.var("query")+"}":"")+"`,").push(addIndentation(stringifyObject(c,{indent:l.indent,inlineCharacterLimit:25,transform:getPreserveTransformer({body:!0,authorizationHeader:u})}),{level:1,indent:l.indent})).push(");").blank().push("const "+m.var("data")+" = await "+m.var("resp")+"."+(y?"json()":"text()")+";").push("console.log("+m.var("data")+");"),m.join().replace(/"fs\.createReadStream\(\\"(.+)\\"\)"/,'fs.createReadStream("$1")')};function addComments(e){e.push("/**"),e.push(" * Requires Node.js >= 14"),e.push(" *"),e.push(' * Requires module "node-fetch" >= 2.6.1'),e.push(" * See here for installation details:"),e.push(" *   https://www.npmjs.com/package/node-fetch"),e.push(" */"),e.blank()}export var info={key:"fetch",title:"Fetch",link:"https://github.com/bitinn/node-fetch",description:"Simplified HTTP node-fetch client"};export default handler;
//# sourceMappingURL=fetch.js.map