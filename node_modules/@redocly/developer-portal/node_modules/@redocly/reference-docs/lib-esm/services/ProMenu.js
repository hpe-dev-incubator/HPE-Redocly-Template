import{__assign,__decorate}from"tslib";import{flattenByProp,SECURITY_SCHEMES_SECTION_PREFIX,querySelector,GROUP_DEPTH}from"../redoc-lib";import{action,observable,makeObservable}from"mobx";import{VersionedSpecStore}from"./VersionedSpecStore";import{SECTION_ATTR}from"../redoc-lib/src/services/constants";import{history as historyInst}from"../redoc-lib/src/services/HistoryService";var ProMenu=function(){function e(e,t,i,n){var r=this;Object.defineProperty(this,"definition",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"scroll",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"history",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"flatItems",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"activeRenderItemIdx",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"renderItems",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"activeItemIdx",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"sideBarOpened",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_unsubscribe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_hashUnsubscribe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getItemById",{enumerable:!0,configurable:!0,writable:!0,value:function(e){return r.flatItems.find((function(t){return t.id===e}))}}),Object.defineProperty(this,"initOnHistory",{enumerable:!0,configurable:!0,writable:!0,value:function(e){void 0===e&&(e=r.history.currentId);var t,i=e.split(r.options.deepLinkPrefix)[0];i&&((t=r.flatItems.find((function(e){return e.id===i})))?(r.activate(t,!1,!1,!1,e),t.active=!1):i.startsWith(SECURITY_SCHEMES_SECTION_PREFIX)&&(t=r.flatItems.find((function(e){return SECURITY_SCHEMES_SECTION_PREFIX.startsWith(e.id)})),r.activate(t,!1,!1,!1,e),t&&(t.active=!1)))}}),Object.defineProperty(this,"updateOnHistory",{enumerable:!0,configurable:!0,writable:!0,value:function(e){void 0===e&&(e=r.history.currentId);var t,i=e.split(r.options.deepLinkPrefix)[0];i&&((t=r.flatItems.find((function(e){return e.id===i})))?r.activateAndScroll(t,!1,void 0,e):(i.startsWith(SECURITY_SCHEMES_SECTION_PREFIX)&&(t=r.flatItems.find((function(e){return SECURITY_SCHEMES_SECTION_PREFIX.startsWith(e.id)})),r.activate(t)),r.scroll.scrollIntoViewBySelector("["+SECTION_ATTR+'="'+i+'"]')))}}),Object.defineProperty(this,"updateVersionOnHistory",{enumerable:!0,configurable:!0,writable:!0,value:function(e){var t=e.split("/")[0],i=r.definition.versionsInfo.findIndex((function(e){return e.id===t}));i<0&&(i=r.definition.versionsInfo.findIndex((function(e){return e.isDefault}))),r.definition.activeVersionIdx!==i&&(r.definition.changeVersion(i<0?0:i),r.updateItemsByVersionChange(!1,e));var n=t+"/"+SECURITY_SCHEMES_SECTION_PREFIX;if(e.startsWith(n)){var o=r.flatItems.find((function(e){return n.startsWith(e.id)}));r.activate(o,!1,!0),setTimeout((function(){return r.scroll.scrollIntoViewBySelector("["+SECTION_ATTR+'="'+e+'"]')}),0)}}}),Object.defineProperty(this,"updateOnScroll",{enumerable:!0,configurable:!0,writable:!0,value:function(e){for(var t=e?1:-1,i=r.activeItemIdx;(-1!==i||e)&&!(i>=r.flatItems.length-1&&e);){if(e){var n=!1,o=r.flatItems[i+1];switch(r.options.pagination){case"section":n=o&&("spec"===o.type||"group"===o.type||"tag"===o.type);break;case"item":n="section"!==(null==o?void 0:o.type)}var a=r.getElementAt(i+1);if(-1===i&&"tag"===r.flatItems[0].type&&(n=!1),r.scroll.isElementBellow(a)||n)break}else{var s=r.flatItems[i]&&r.flatItems[i].type;n="section"===r.options.pagination&&("spec"===s||"group"===s||"tag"===s)||"item"===r.options.pagination&&"section"!==s,a=r.getElementAt(i);if(r.scroll.isElementAbove(a)||n)break}i+=t}var l=r.flatItems[i];"none"===r.options.pagination||"section"===r.options.pagination?l&&l.active||r.activate(l,!0,!0,!1):l&&"section"===l.type&&(l.active||r.activate(l,!0,!0,!1))}}),makeObservable(this),this.items=e.contentItems,this.flatItems=flattenByProp(this.items||[],"items"),this.flatItems.forEach((function(e,t){return e.absoluteIdx=t})),i.disableSidebar||this.subscribe(),this.flatItems.forEach((function(e,t){return normalizeItem(e,t,i.pagination,r.definition instanceof VersionedSpecStore)})),this.renderItems=this.buildRenderItems(0),this.activeItemIdx=-1,this.activeRenderItemIdx=-1,this.definition instanceof VersionedSpecStore&&this.history.subscribe(this.updateVersionOnHistory)}return Object.defineProperty(e,"updateOnHistory",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){void 0===e&&(e=historyInst.currentId),e&&t.scrollIntoViewBySelector("["+SECTION_ATTR+'="'+e+'"]')}}),Object.defineProperty(e.prototype,"subscribe",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._unsubscribe=this.scroll.subscribe(this.updateOnScroll),this._hashUnsubscribe=this.history.subscribe(this.updateOnHistory)}}),Object.defineProperty(e.prototype,"toggleSidebar",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.sideBarOpened=!this.sideBarOpened}}),Object.defineProperty(e.prototype,"closeSidebar",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.sideBarOpened=!1}}),Object.defineProperty(e.prototype,"getElementAt",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this.flatItems[e];return t&&querySelector("["+SECTION_ATTR+'="'+t.id+'"]')||null}}),Object.defineProperty(e.prototype,"getElementAtOrFirstChild",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this.flatItems[e];return t&&"group"===t.type&&(t=t.items[0]),t&&querySelector("["+SECTION_ATTR+'="'+t.id+'"]')||null}}),Object.defineProperty(e.prototype,"activeItem",{get:function(){return this.flatItems[this.activeItemIdx]||void 0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"updateItemsByVersionChange",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){var i=this,n=this.activeItem&&this.activeItem.active?this.activeItem.absoluteIdx:-1;t=t&&withoutVersion(t)||this.activeItem&&this.activeItem.active&&withoutVersion(this.activeItem.id)||"",this.deactivate(this.activeItem),this.items=this.definition.contentItems,this.flatItems=flattenByProp(this.items||[],"items"),this.flatItems.forEach((function(e,t){return normalizeItem(e,t,i.options.pagination,i.definition instanceof VersionedSpecStore)}));var r=t?(this.flatItems.find((function(e){return withoutVersion(e.id)===t}))||{absoluteIdx:-1}).absoluteIdx:-1;if(-1!==r&&"none"!==this.options.pagination||(this.renderItems=this.buildRenderItems(0)),this.activeItemIdx=-1,-1!==r)this.activate(this.flatItems[r],e);else if(-1!==n)this.activateAndScroll(this.flatItems[0],e);else if(e){var o=this.definition.versionsInfo[this.definition.activeVersionIdx];if(!this.history.currentId&&o.isDefault)return;this.history.replace(o.id)}}}),Object.defineProperty(e.prototype,"buildRenderItems",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if("none"===this.options.pagination)return this.items;var t=this.flatItems[e];if(t||(t=this.flatItems[0]),"spec"===t.type)return this.buildRenderItems(e+1);if("section"===t.type){var i=[],n=getParentOfType(t,"tag");if("section"===this.options.pagination&&n)return[n];if("item"===this.options.pagination&&n)return[__assign(__assign({},n),{items:getLeadingSectionItems(n)})];for(var r=getParentSpecItem(t),o=(null==r?void 0:r.items)||this.items,a=0;a<o.length&&"section"===o[a].type;a++)i.push(o[a]);return i}switch(this.options.pagination){case"section":if("operation"===t.type&&t.parent)return[t.parent];if("group"!==t.type)return[t];case"item":return"operation"===t.type?[t]:[__assign(__assign({},t),{items:getLeadingSectionItems(t)})];default:return[]}}}),Object.defineProperty(e.prototype,"activateBase",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,n){var r,o,a,s,l,c=this;if(void 0===t&&(t=!0),void 0===i&&(i=!1),(null===(r=this.activeItem)||void 0===r?void 0:r.id)===(null==e?void 0:e.id)&&!n)return t&&e&&this.history.replace(e.id,i),void(e&&!e.active&&e.activate());if(!e||"group"!==e.type)if(this.deactivate(this.activeItem),e){if(!(e.depth<=GROUP_DEPTH)){this.activeItemIdx=e.absoluteIdx,t&&this.history.replace(e.id,i),e.activate(),e.expand();var u=new URLSearchParams(n),d="request"===u.get("t"),f="response"===u.get("t"),p=u.get("c"),v=u.get("ct"),b=u.get("in"),m=u.get("path"),h=(null==m?void 0:m.split(this.options.deepLinkSeparator))||[];if(b)for(var I=e.parameters,y=function(e){var t=null==I?void 0:I.find((function(t){return t.name===e}));null==t||t.expand(),I=null===(o=null==t?void 0:t.schema)||void 0===o?void 0:o.fields},g=0,O=h;g<O.length;g++){y(O[g])}else if(d){var S=null===(a=e.requestBody)||void 0===a?void 0:a.content;null==S||S.activate(Number(v)||(null==S?void 0:S.activeMimeIdx)),setTimeout((function(){var e;return c.activateField(h,null===(e=null==S?void 0:S.active)||void 0===e?void 0:e.schema)}),0)}else if(f){var _=e.responses.find((function(e){return e.code===p}));(null==_?void 0:_.expanded)||null==_||_.expand(),null===(s=null==_?void 0:_.content)||void 0===s||s.activate(Number(v)||(null===(l=_.content)||void 0===l?void 0:l.activeMimeIdx)),setTimeout((function(){var e,t;return c.activateField(h,null===(t=null===(e=null==_?void 0:_.content)||void 0===e?void 0:e.active)||void 0===t?void 0:t.schema)}),0)}}}else this.history.replace("",i)}}),Object.defineProperty(e.prototype,"activate",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,n,r){var o=this;if(void 0===t&&(t=!0),void 0===i&&(i=!1),void 0===n&&(n=!0),"none"===this.options.pagination)return this.activateBase(e,t,i,r),void(!e&&this.definition instanceof VersionedSpecStore&&this.history.replace(this.definition.currentVersionId,!0));if("group"!==(null==e?void 0:e.type)){if(e&&"item"===this.options.pagination&&"tag"===e.type&&!e.description){if(e.expanded)return void e.collapse();e.expand(),e=this.flatItems[e.absoluteIdx+1]}if(this.activateBase(e,e&&t,i,r),this.activeRenderItemIdx=e?e.absoluteIdx:this.activeRenderItemIdx,this.activeRenderItemIdx>=0){var a=this.buildRenderItems(this.activeRenderItemIdx);a.some((function(e,t){return e.id!==o.renderItems[t].id}))&&(this.renderItems=a),this.renderItems[0]&&(this.activeRenderItemIdx=this.renderItems[0].absoluteIdx)}n&&setTimeout((function(){return o.scrollToActive()})),!e&&this.definition instanceof VersionedSpecStore&&this.history.replace(this.definition.currentVersionId,!0)}}}),Object.defineProperty(e.prototype,"activateField",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){for(var i,n=function(n){var r=e[n],o=n===e.length-1;if("array"===(null==t?void 0:t.type)&&(null==t?void 0:t.items)&&(t=null==t?void 0:t.items),null==t?void 0:t.oneOf){var a=Number(r);return null==t||t.activateOneOf(a),t=null==t?void 0:t.oneOf[a],"continue"}"array"===(null==t?void 0:t.type)&&(null==t?void 0:t.items)&&(t=null==t?void 0:t.items);var s=null===(i=null==t?void 0:t.fields)||void 0===i?void 0:i.find((function(e){return e.name===r}));o||null==s||s.expand(),t=null==s?void 0:s.schema},r=0;r<e.length-1;r++)n(r)}}),Object.defineProperty(e.prototype,"deactivate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(void 0!==e)for(e.deactivate();void 0!==e;)e.collapse(),e=e.parent}}),Object.defineProperty(e.prototype,"activateAndScroll",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t,i,n){void 0===n&&(n="");var r=n.split(this.options.deepLinkPrefix)[1],o=e&&this.getItemById(e.id)||e;this.activate(o,t,i,!1,r),this.scrollToActive(r?n:""),o&&o.items.length||this.closeSidebar()}}),Object.defineProperty(e.prototype,"scrollToActive",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;e?setTimeout((function(){return t.scroll.scrollIntoViewBySelector("["+SECTION_ATTR+'="'+e+'"]')}),0):this.scroll.scrollIntoView(this.getElementAt(this.activeItemIdx))}}),Object.defineProperty(e.prototype,"dispose",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t;null===(e=this._unsubscribe)||void 0===e||e.call(this),null===(t=this._hashUnsubscribe)||void 0===t||t.call(this)}}),__decorate([observable],e.prototype,"flatItems",void 0),__decorate([observable],e.prototype,"items",void 0),__decorate([observable],e.prototype,"activeRenderItemIdx",void 0),__decorate([observable.ref],e.prototype,"renderItems",void 0),__decorate([observable],e.prototype,"activeItemIdx",void 0),__decorate([observable],e.prototype,"sideBarOpened",void 0),__decorate([action],e.prototype,"toggleSidebar",null),__decorate([action],e.prototype,"closeSidebar",null),__decorate([action],e.prototype,"activateBase",null),__decorate([action],e.prototype,"activate",null),__decorate([action.bound],e.prototype,"activateAndScroll",null),e}();export{ProMenu};function withoutVersion(e){return e.split("/").slice(1).join("/")}function getParentSpecItem(e){for(;e;){if("spec"===e.type)return e;e=e.parent}}function getParentOfType(e,t){if(e&&e.parent)return e.parent.type===t?e.parent:getParentOfType(e.parent,t)}function getLeadingSectionItems(e){for(var t=[],i=0,n=e.items;i<n.length;i++){var r=n[i];if("section"!==r.type)break;t.push(r)}return t}function normalizeItem(e,t,i,n){if(e.absoluteIdx=t,"none"!==i){var r=getParentOfType(e,"tag");if(e.parent&&r&&!e._id_normalized){if(n){var o=e.id.split("/"),a=o[0],s=o[1],l=withoutVersion(e.id);if("operation"===e.type&&!s.startsWith("operation"))return;e.id=a+"/"+withoutVersion(r.id)+"/"+l}else{if("operation"===e.type&&!e.id.startsWith("operation"))return;e.id=r.id+"/"+e.id}e._id_normalized=!0}}}
//# sourceMappingURL=ProMenu.js.map