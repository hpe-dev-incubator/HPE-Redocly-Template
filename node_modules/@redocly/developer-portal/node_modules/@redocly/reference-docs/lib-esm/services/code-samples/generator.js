import{__assign}from"tslib";import{HTTPSnippet}from"./httpsnippet";import{serializeParameterValue}from"../../redoc-lib";import{parse as parseQueryString,stringify as stringifyQueryString}from"query-string";import*as Sampler from"openapi-sampler";import{getSecurityDetails,getParameterValue}from"../../utils";import{isSameMime,normalizeMimeType}from"../utils";function mapOperationToHAR(e,a){var t,r,i,n,s,o,l,u=a.exampleName,p=void 0===u?"":u,c=a.skipOptionalParameters,d=void 0!==c&&c,m=a.withOAuth2Call,h=void 0!==m&&m,f=a.spec,v=a.generatedPayloadSamplesMaxDepth,g=void 0===v?8:v,y=getSecurityData(null===(t=e.security)||void 0===t?void 0:t[0],h),O=y.securityHeaders,_=y.securityCookies,S=y.securityQueries,T=y.securityOAuth2ExtraCalls,w=y.basicAuth,C=null===(i=null===(r=e.requestBody)||void 0===r?void 0:r.content)||void 0===i?void 0:i.active,A={skipNonRequired:d,skipReadOnly:!0,maxSampleDepth:g},x=!1,E=e.parameters.filter((function(e){return"header"===e.in})).filter((function(e){return!(d&&!e.required)})).map((function(e){return{name:e.name,value:getParameterValue("header",e.name)||serializeParameterValue(e,Sampler.sample(e.schema.rawSchema,A,f))}})).map((function(e){return(null==C?void 0:C.name)&&"content-type"===e.name.toLowerCase()&&(x=!0,e.value=C.name),e})).concat(O);!x&&(null==C?void 0:C.name)&&E.unshift({name:"Content-Type",value:null==C?void 0:C.name});var P=e.parameters.filter((function(e){return"cookie"===e.in})).filter((function(e){return!(d&&!e.required)})).map((function(e){return parseQueryString(serializeParameterValue(e,Sampler.sample(e.schema.rawSchema,A,f)))})).reduce((function(e,a){for(var t=0,r=Object.entries(a);t<r.length;t++){var i=r[t],n=i[0],s=i[1];e.push({name:n,value:String(s)})}return e}),[]).concat(_),k=e.parameters.filter((function(e){return"query"===e.in})).filter((function(e){return!(d&&!e.required)})).map((function(e){return parseQueryString(serializeParameterValue(e,Sampler.sample(e.schema.rawSchema,A,f)))})).reduce((function(e,a){for(var t=0,r=Object.entries(a);t<r.length;t++){var i=r[t],n=i[0],s=i[1];e.push({name:n,value:String(s)})}return e}),[]).concat(S),H=(null===(n=e.servers[0])||void 0===n?void 0:n.url.replace(/\/$/,""))+"/"+e.path.replace(/^\//,""),b=e.parameters.filter((function(e){return"path"===e.in})).reduce((function(e,a){var t=a.in,r=a.name;return e[r]=getParameterValue(t,r),e}),{}),R=(null===(o=null===(s=null==C?void 0:C.examples)||void 0===s?void 0:s[p])||void 0===o?void 0:o.value)||(null===(l=Object.values((null==C?void 0:C.examples)||{})[0])||void 0===l?void 0:l.value),z=null==C?void 0:C.name.toLowerCase(),D=isSameMime(z,"application/x-www-form-urlencoded")||isSameMime(z,"multipart/form-data"),j="application/json"===normalizeMimeType(z)?JSON.stringify(R):String(R||"");!j&&D&&(j=(null==C?void 0:C.schema)?stringifyQueryString(Sampler.sample(C.schema.rawSchema,A,f)):"");var N=D?objectToHarParams(parseQueryString(j)):[],q=j?{mimeType:(null==C?void 0:C.name)||"",text:j,params:N}:void 0;return{method:e.httpVerb,url:H,httpVersion:"HTTP/1.1",cookies:P,headers:E,queryString:k,postData:q,headersSize:-1,bodySize:-1,securityOAuth2ExtraCalls:T,basicAuth:w,pathParameters:b}}var defaultOptions={withImports:!0,withComments:!1},langToSnippetConfig={curl:{code:"shell",defaultTarget:"curl",defaultOptions:__assign(__assign({},defaultOptions),{short:!0})},JavaScript:{code:"javascript",defaultTarget:"fetch",defaultOptions:__assign(__assign({},defaultOptions),{withImports:!1})},"Node.js":{code:"node",defaultTarget:"fetch",defaultOptions:__assign({},defaultOptions)},Python:{code:"python",defaultTarget:"requests",defaultOptions:__assign({},defaultOptions)},"Java8+Apache":{code:"java8",defaultTarget:"apachehttp",defaultOptions:__assign({},defaultOptions)},Java:{code:"java",defaultTarget:"httpclient",defaultOptions:__assign({},defaultOptions)},"C#":{code:"csharp",defaultTarget:"httpclient",defaultOptions:__assign({},defaultOptions)},Go:{code:"go",defaultTarget:"http.DefaultClient",defaultOptions:__assign({},defaultOptions)}};export function getCodeSample(e){var a=e.lang,t=e.operation,r=e.exampleName,i=e.options,n=void 0===i?{}:i;try{var s=n,o=mapOperationToHAR(t,{exampleName:r,skipOptionalParameters:s.skipOptionalParameters,withOAuth2Call:s.withOAuth2Call,spec:s.spec,generatedPayloadSamplesMaxDepth:s.generatedPayloadSamplesMaxDepth}),l=new HTTPSnippet(o);return langToSnippetConfig[a]?l.convert(langToSnippetConfig[a].code,langToSnippetConfig[a].defaultTarget,__assign(__assign({},langToSnippetConfig[a].defaultOptions),n)):"Language is not supported."}catch(e){return console.error(e),"Failed to generate code sample."}}function getSecurityData(e,a){for(var t,r,i,n,s={securityHeaders:[],securityCookies:[],securityQueries:[],securityOAuth2ExtraCalls:[],basicAuth:void 0},o=0,l=(null==e?void 0:e.schemes)||[];o<l.length;o++){var u=l[o],p=getSecurityDetails(u.id);switch(u.type){case"openIdConnect":null===(t=s.securityHeaders)||void 0===t||t.push({name:"Authorization",value:"Bearer <YOUR_TOKEN_HERE>"});break;case"oauth2":var c=p.token?(p.token.token_type||"Bearer")+" "+p.token.access_token:"Bearer <YOUR_TOKEN_HERE>";u.flows.clientCredentials&&a?s.securityOAuth2ExtraCalls.push(getOAuth2ClientCredsCallHar(u.flows.clientCredentials,u.scopes,p)):u.flows.password&&a&&s.securityOAuth2ExtraCalls.push(getOAuth2PasswordCallHar(u.flows.password,u.scopes,p)),null===(r=s.securityHeaders)||void 0===r||r.push({name:"Authorization",value:c});break;case"apiKey":var d=p.raw||"YOUR_API_KEY_HERE";"header"===u.in&&(null===(i=s.securityHeaders)||void 0===i||i.push({name:u.name,value:d})),"cookie"===u.in&&s.securityCookies.push({name:u.name,value:d}),"query"===u.in&&s.securityQueries.push({name:u.name,value:d});break;case"http":"basic"===u.scheme?s.basicAuth={username:p.username||"<username>",password:p.password||"<password>"}:null===(n=s.securityHeaders)||void 0===n||n.push({name:"Authorization",value:capitalizeFirst(u.scheme||"bearer")+" <YOUR_"+(u.bearerFormat||"TOKEN")+"_HERE>"})}}return s}function getOAuth2PasswordCallHar(e,a,t){return{method:"POST",url:e.tokenUrl,httpVersion:"HTTP/1.1",headers:[{name:"Content-Type",value:"application/x-www-form-urlencoded"},{name:"Accept",value:"application/json"}],queryString:[],postData:{mimeType:"application/x-www-form-urlencoded",text:"",params:[{name:"grant_type",value:"password"},{name:"client_id",value:t.client_id||"YOUR_CLIENT_ID"},{name:"client_secret",value:t.client_secret||"YOUR_CLIENT_SECRET"},{name:"username",value:t.username||"<username>"},{name:"password",value:t.password||"<password>"},a.length?{name:"scope",value:a.join(" ")}:void 0].filter(isDefined)},cookies:[],headersSize:-1,bodySize:-1,securityOAuth2ExtraCalls:[]}}function getOAuth2ClientCredsCallHar(e,a,t){return{method:"POST",url:e.tokenUrl,httpVersion:"HTTP/1.1",headers:[{name:"Content-Type",value:"application/x-www-form-urlencoded"},{name:"Accept",value:"application/json"}],queryString:[],postData:{mimeType:"application/x-www-form-urlencoded",text:"",params:[{name:"grant_type",value:"client_credentials"},{name:"client_id",value:t.client_id||"YOUR_CLIENT_ID"},{name:"client_secret",value:t.client_secret||"YOUR_CLIENT_SECRET"},a.length?{name:"scope",value:a.join(" ")}:void 0].filter(isDefined)},cookies:[],headersSize:-1,bodySize:-1,securityOAuth2ExtraCalls:[]}}function objectToHarParams(e){for(var a=[],t=0,r=Object.entries(e);t<r.length;t++){var i=r[t],n=i[0],s=i[1];a.push({name:n,value:String(s)})}return a}export function isDefined(e){return void 0!==e}export function capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}
//# sourceMappingURL=generator.js.map