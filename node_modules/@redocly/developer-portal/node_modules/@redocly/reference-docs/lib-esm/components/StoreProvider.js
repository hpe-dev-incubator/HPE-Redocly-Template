var _a;import{__awaiter,__generator}from"tslib";import*as React from"react";import{loadAndBundleDefinition}from"../redoc-lib";import{ProStore}from"../services/ProStore";import slugify from"slugify";import isDeepEqual from"fast-deep-equal";import{FakeHistoryService}from"../services";export var Provider=(_a=React.createContext(void 0),_a.Provider),Consumer=_a.Consumer;export var ProStoreProvider=function(e){var t=e.definitions,r=e.options,n=e.definitionUrl,i=e.definition,a=e.activeItemId,o=e.activeSampleLanguage,s=e.activeDeepLink,c=e.children,u=React.useState()[1],l=React.useState(!0),d=l[0],f=l[1],p=React.useState(null),v=p[0],m=p[1];React.useEffect((function(){!function(){__awaiter(this,void 0,void 0,(function(){var e,a,o;return __generator(this,(function(s){switch(s.label){case 0:f(!0),s.label=1;case 1:return s.trys.push([1,6,,7]),e=m,t?[4,loadMany(t)]:[3,3];case 2:return a=s.sent(),[3,5];case 3:return[4,loadSingle(i,n,r)];case 4:a=s.sent(),s.label=5;case 5:return e.apply(void 0,[a]),[3,7];case 6:return o=s.sent(),u((function(){throw o})),[3,7];case 7:return[2]}}))}))}()}),[t,i,n]);var h=React.useMemo((function(){if(v)return new ProStore(v,n,r)}),useDeepCompareMemoize([v,r]));return React.useEffect((function(){if(h)return f(!1),function(){return h.dispose()}}),[h]),React.useEffect((function(){var e;if(h&&a){var t=(null==a?void 0:a.split(h.options.deepLinkPrefix)[0])||(null===(e=h.menu.flatItems[h.menu.activeItemIdx])||void 0===e?void 0:e.id),r=h.menu.flatItems.find((function(e){return e.id===t})),n=s?t+h.options.deepLinkPrefix+s:void 0;n&&h.menu.history instanceof FakeHistoryService&&h.menu.history.replaceForField(n),h.menu.activateAndScroll(r,!0,!1,n)}}),[a,s,h]),React.useEffect((function(){h&&o&&h.setActiveSampleLanguage(o)}),[o,h]),c({loading:d,store:h})};function fixSpec(e){for(var t=e.components&&e.components.securitySchemes||{},r=0,n=Object.keys(t);r<n.length;r++){var i=t[n[r]];i["x-type"]&&(i.type=i["x-type"]),i["x-scheme"]&&(i.scheme=i["x-scheme"])}}function loadMany(e){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,loadSpecs(e||[])];case 1:return t.sent(),[2,e]}}))}))}function loadSingle(e,t,r){return __awaiter(this,void 0,void 0,(function(){var n,i,a,o;return __generator(this,(function(s){switch(s.label){case 0:if(!(null==r?void 0:r.skipBundleAndConvert))return[3,1];if(!e)throw new Error('spec must be specified when using "skipBundleAndConvert"');return n=e,[3,3];case 1:return[4,loadAndBundleDefinition(e||t)];case 2:n=s.sent(),s.label=3;case 3:if(!(i=null==r?void 0:r.unstable_externalDescription))return[3,8];s.label=4;case 4:return s.trys.push([4,7,,8]),[4,fetch(i)];case 5:return[4,s.sent().text()];case 6:return a=s.sent(),n.info.description=a,[3,8];case 7:return o=s.sent(),console.warn("Failed to load external description from "+i+": "+o.message),[3,8];case 8:try{fixSpec(n)}catch(e){}return[2,n]}}))}))}function loadAndBundleSpecOrMd(e,t){return e.endsWith(".md")?loadAndBundleDefinition({openapi:"3.0.0",info:{title:t||"",version:"1.0",description:{$ref:e}},paths:{}}):loadAndBundleDefinition(e)}export function loadSpecs(e){return __awaiter(this,void 0,void 0,(function(){var t,r,n,i,a,o,s,c,u,l,d;return __generator(this,(function(f){switch(f.label){case 0:if(!Array.isArray(e))return[3,8];t=0,r=e,f.label=1;case 1:return t<r.length?((n=r[t]).id=n.id||slugify(n.title),n.url?[4,loadAndBundleSpecOrMd(n.url,n.title)]:[3,3]):[3,8];case 2:return d=f.sent(),n.definition=d,[3,7];case 3:i=0,a=n.items||[],f.label=4;case 4:return i<a.length?(o=a[i]).url?[4,loadAndBundleSpecOrMd(o.url,n.title)]:[3,6]:[3,7];case 5:d=f.sent(),o.definition=d,f.label=6;case 6:return i++,[3,4];case 7:return t++,[3,1];case 8:if(s=e.versions,!Array.isArray(s))return[3,12];c=0,u=s,f.label=9;case 9:return c<u.length?(l=u[c]).url?[4,loadAndBundleSpecOrMd(l.url)]:[3,11]:[3,12];case 10:d=f.sent(),l.spec=d,f.label=11;case 11:return c++,[3,9];case 12:return[2]}}))}))}function useDeepCompareMemoize(e){var t=React.useRef(),r=React.useRef(0);return isDeepEqual(e,t.current)||(t.current=e,r.current+=1),[r.current]}
//# sourceMappingURL=StoreProvider.js.map