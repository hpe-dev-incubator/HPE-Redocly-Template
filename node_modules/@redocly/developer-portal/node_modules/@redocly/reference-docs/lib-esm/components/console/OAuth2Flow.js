import{__assign,__extends,__makeTemplateObject}from"tslib";import*as React from"react";import{styled,OptionsContext}from"../../redoc-lib";import{LinearProgress}from"../common/LinearProgress";import{FormControl,FormLabel,FormError,FormWrapper,FormWarning}from"../common/form";import{OAuth2}from"../../services/OAuth2";import{fromStorage,getSecurityDetailsOptions}from"../../utils";import Scope from"./Scope";import{Button}from"../shared";import{FormDropdown,FormTextField,TextField}from"../common/TextField";import{normalizeUrlProtocol}from"./utils";function requiredValidator(e){if(!e)return"Field is required"}var OAuth2Flow=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return Object.defineProperty(t,"state",{enumerable:!0,configurable:!0,writable:!0,value:{error:null,loading:!1}}),Object.defineProperty(t,"clearToken",{enumerable:!0,configurable:!0,writable:!0,value:function(){t.props.formApi.setValue("auth."+t.props.id+".token","")}}),t}return __extends(t,e),Object.defineProperty(t.prototype,"values",{get:function(){return this.props.form.values&&this.props.form.values.auth&&this.props.form.values.auth[this.props.id]||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"errors",{get:function(){return this.props.form.errors&&this.props.form.errors.auth&&this.props.form.errors.auth[this.props.id]||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"handleAuthorize",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;if(e){this.props.formApi.validate();var r=this.props,o=r.flow,a=r.id,l=r.tokenUrl,n=r.authCorsProxyUrl;if(this.values.client_id&&("authorizationCode"!==o||this.values.client_secret)){this.setState({loading:!0,error:null});var i=n?n+normalizeUrlProtocol(e):e,s=n&&l?n+normalizeUrlProtocol(l):l,c=this.props.formApi.getValue("auth."+a+".scopes"),u={authorizationUrl:i.startsWith("http")?i:this.props.server+i,clientId:this.values.client_id,scopes:c,redirectUri:this.context.oAuth2RedirectURI,routingBasePath:this.context.routingBasePath,successCallback:function(e){t.props.formApi.setValue("auth."+t.props.id+".token",e),t.setState({loading:!1,error:null})},errorCallback:function(e){t.setState({loading:!1,error:(null==e?void 0:e.message)||"Failed to retrieve the access token"})}};"implicit"===o&&OAuth2.authorizeImplicit(u),"authorizationCode"===o&&OAuth2.authorizeAuthorizationCode(__assign(__assign({},u),{tokenUrl:(null==s?void 0:s.startsWith("http"))?s:this.props.server+s,clientSecret:this.values.client_secret}))}}}}),Object.defineProperty(t.prototype,"handleLogout",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.clearToken(),this.setState({error:null})}}),Object.defineProperty(t.prototype,"handleCancel",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.setState({loading:!1,error:null}),OAuth2.clearRedirectData(this.props.flow)}}),Object.defineProperty(t.prototype,"render",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,r=this,o=this.state,a=o.error,l=o.loading,n=this.props,i=n.id,s=n.scopes,c=n.authorizationUrl,u=n.flow;if(!c)return React.createElement(FormError,null,"No flow info");var p=fromStorage("auth."+i+".token");p=p?JSON.parse(p):"";var m=getSecurityDetailsOptions(i,"client_id"),d={field:"auth."+i+".client_id",fullWidth:!0,initialValue:fromStorage("auth."+i+".client_id")||this.props.clientId,initValue:fromStorage("auth."+i+".client_id")||this.props.clientId,placeholder:"Your OAuth2 app Client ID",validate:requiredValidator,validateOnBlur:!0,validateOnChange:!0};return React.createElement("div",null,React.createElement(FormWrapper,null,React.createElement(FormControl,null,React.createElement(FormLabel,null," Client ID: "),m?React.createElement(FormDropdown,__assign({},d,{options:m})):React.createElement(FormTextField,__assign({},d))),"authorizationCode"===u&&React.createElement(FormControl,null,React.createElement(FormLabel,null,"Client Secret:"),React.createElement(FormTextField,{type:"password",fullWidth:!0,field:"auth."+i+".client_secret",initialValue:fromStorage("auth."+i+".client_secret"),validate:requiredValidator,validateOnBlur:!0,validateOnChange:!0})),React.createElement(FormTextField,{fullWidth:!0,field:"auth."+i+".token",type:"hidden",initialValue:p,validate:requiredValidator}),React.createElement(Scope,{id:i,scopes:s}),this.values.token&&this.values.token.access_token?React.createElement(FormControl,null,React.createElement(FormLabel,null," Access Token: "),React.createElement(TextField,{disabled:!0,type:"password",fullWidth:!0,value:this.values.token.access_token})):null),React.createElement(ButtonsWrapper,null,this.values.token&&this.values.token.access_token?React.createElement(Button,{fullWidth:!0,onClick:function(){r.handleLogout()}},"Log out"):React.createElement(React.Fragment,null,l?React.createElement(React.Fragment,null,React.createElement(Button,{fullWidth:!0,onClick:function(){r.handleCancel()}},"Cancel"),React.createElement(LinearProgress,null)):React.createElement(Button,{fullWidth:!0,disabled:(null===(t=null===(e=this.props)||void 0===e?void 0:e.formApi)||void 0===t?void 0:t.getTouched("auth."+i+".client_id"))&&!this.values.client_id,onClick:function(){r.handleAuthorize(c)}},"Authorize"))),l||a||!this.values.token||!this.values.token.access_token&&React.createElement(FormWrapper,null,React.createElement(FormControl,null,l?React.createElement(FormWarning,null,"Please, finish your authorization flow or cancel authorization."):a?React.createElement(React.Fragment,null,React.createElement(OriginalErrorMessage,null,React.createElement(FormError,null,a))):this.values.token&&this.values.token.access_token?null:React.createElement(FormWarning,null," No Access Token. Please, Authorize. "))))}}),Object.defineProperty(t,"contextType",{enumerable:!0,configurable:!0,writable:!0,value:OptionsContext}),t}(React.Component);export{OAuth2Flow};var templateObject_1,templateObject_2,OriginalErrorMessage=styled.div(templateObject_1||(templateObject_1=__makeTemplateObject(["\n  font-family: monospace;\n  margin-top: 10px;\n  line-height: 1;\n  padding-left: 10px;\n  border-left: 1px solid gray;\n"],["\n  font-family: monospace;\n  margin-top: 10px;\n  line-height: 1;\n  padding-left: 10px;\n  border-left: 1px solid gray;\n"]))),ButtonsWrapper=styled.div(templateObject_2||(templateObject_2=__makeTemplateObject(["\n  margin-bottom: 15px;\n"],["\n  margin-bottom: 15px;\n"])));
//# sourceMappingURL=OAuth2Flow.js.map