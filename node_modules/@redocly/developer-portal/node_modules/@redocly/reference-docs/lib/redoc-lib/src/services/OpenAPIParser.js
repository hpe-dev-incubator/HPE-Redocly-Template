"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),url_1=require("url"),utils_1=require("../utils/"),JsonPointer_1=require("../utils/JsonPointer"),utils_2=require("../utils"),MarkdownRenderer_1=require("./MarkdownRenderer"),RedocNormalizedOptions_1=require("./RedocNormalizedOptions"),RefCounter=function(){function e(){Object.defineProperty(this,"_counter",{enumerable:!0,configurable:!0,writable:!0,value:{}})}return Object.defineProperty(e.prototype,"reset",{enumerable:!1,configurable:!0,writable:!0,value:function(){this._counter={}}}),Object.defineProperty(e.prototype,"visit",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._counter[e]=this._counter[e]?this._counter[e]+1:1}}),Object.defineProperty(e.prototype,"exit",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this._counter[e]=this._counter[e]&&this._counter[e]-1}}),Object.defineProperty(e.prototype,"visited",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return!!this._counter[e]}}),e}(),OpenAPIParser=function(){function e(e,r,t){var i=this;void 0===t&&(t=new RedocNormalizedOptions_1.RedocNormalizedOptions({})),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"definitionUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"definition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hasSecurityDefinitions",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_refCounter",{enumerable:!0,configurable:!0,writable:!0,value:new RefCounter}),Object.defineProperty(this,"allowMergeRefs",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"byRef",{enumerable:!0,configurable:!0,writable:!0,value:function(e){var r;if(i.definition){"#"!==e.charAt(0)&&(e="#"+e),e=decodeURIComponent(e);try{r=JsonPointer_1.JsonPointer.get(i.definition,e)}catch(e){}return r||{}}}}),this.validate(e),this.preprocess(e),this.definition=e,this.hasSecurityDefinitions=this.containsSecurity(e),this.allowMergeRefs=e.openapi.startsWith("3.1");var n=utils_1.IS_BROWSER?window.location.href:"";"string"==typeof r&&(this.definitionUrl=url_1.resolve(n,r))}return Object.defineProperty(e.prototype,"validate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(void 0===e.openapi)throw new Error("Document must be valid OpenAPI 3.0.0 definition")}}),Object.defineProperty(e.prototype,"containsSecurity",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var r=e.info&&e.info.description||"";return MarkdownRenderer_1.MarkdownRenderer.containsComponent(r,utils_2.SECURITY_DEFINITIONS_COMPONENT_NAME)||MarkdownRenderer_1.MarkdownRenderer.containsComponent(r,utils_2.SECURITY_DEFINITIONS_JSX_NAME)}}),Object.defineProperty(e.prototype,"preprocess",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(e.info&&this.options.hideInfoDescription)e.info.description="";else if(!this.options.noAutoAuth&&e.info&&e.components&&e.components.securitySchemes){var r=e.info.description||"";if(!this.containsSecurity(e)){var t=MarkdownRenderer_1.buildComponentComment(utils_2.SECURITY_DEFINITIONS_COMPONENT_NAME);e.info.description=utils_1.appendToMdHeading(r,"Authentication",t)}}}}),Object.defineProperty(e.prototype,"isRef",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return!!e&&(void 0!==e.$ref&&null!==e.$ref)}}),Object.defineProperty(e.prototype,"resetVisited",{enumerable:!1,configurable:!0,writable:!0,value:function(){if("production"!==process.env.NODE_ENV)for(var e in this._refCounter._counter)this._refCounter._counter[e]>0&&console.warn("Not exited reference: "+e);this._refCounter=new RefCounter}}),Object.defineProperty(e.prototype,"exitRef",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.isRef(e)&&this._refCounter.exit(e.$ref)}}),Object.defineProperty(e.prototype,"deref",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r,t){if(void 0===r&&(r=!1),void 0===t&&(t=!1),this.isRef(e)){var i=utils_2.getDefinitionName(e.$ref);if(i&&this.options.ignoreNamedSchemas.has(i))return{type:"object",title:i};var n=this.byRef(e.$ref),o=this._refCounter.visited(e.$ref);if(this._refCounter.visit(e.$ref),o&&!r)return Object.assign({},n,{"x-circular-ref":!0});var s=n;return this.isRef(n)&&(s=this.deref(n,!1,t),this.exitRef(n)),this.allowMergeRefs?this.mergeRefs(e,n,t):s}return e}}),Object.defineProperty(e.prototype,"mergeRefs",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r,t){e.$ref;var i=tslib_1.__rest(e,["$ref"]),n=Object.keys(i);return 0===n.length?r:t&&n.some((function(e){return"description"!==e&&"title"!==e&&"externalDocs"!==e}))?{allOf:[r,i]}:tslib_1.__assign(tslib_1.__assign({},r),i)}}),Object.defineProperty(e.prototype,"shallowDeref",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(this.isRef(e)){var r=utils_2.getDefinitionName(e.$ref);return r&&this.options.ignoreNamedSchemas.has(r)?{type:"object",title:r}:this.byRef(e.$ref)}return e}}),Object.defineProperty(e.prototype,"mergeAllOf",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r,t,i){var n=this;if(void 0===t&&(t=!1),void 0===i&&(i=new Set),r&&i.add(r),void 0===(e=this.hoistOneOfs(e)).allOf)return e;var o=tslib_1.__assign(tslib_1.__assign({},e),{allOf:void 0,parentRefs:[],title:e.title||utils_2.getDefinitionName(r)});void 0!==o.properties&&"object"==typeof o.properties&&(o.properties=tslib_1.__assign({},o.properties)),void 0!==o.items&&"object"==typeof o.items&&(o.items=tslib_1.__assign({},o.items));for(var s=0,a=e.allOf.map((function(e){var r;if(!(e&&e.$ref&&i.has(e.$ref))){var s=n.deref(e,t,!0),a=e.$ref||void 0,f=n.mergeAllOf(s,a,t,i);return(r=o.parentRefs).push.apply(r,f.parentRefs||[]),{$ref:a,schema:f}}})).filter((function(e){return void 0!==e}));s<a.length;s++){var f=a[s],l=f.$ref,u=f.schema;if(o.type!==u.type&&void 0!==o.type&&void 0!==u.type&&console.warn('Incompatible types in allOf at "'+r+'": "'+o.type+'" and "'+u.type+'"'),void 0!==u.type&&(o.type=u.type),void 0!==u.properties)for(var p in o.properties=o.properties||{},u.properties)if(o.properties[p]){var c=this.mergeAllOf({allOf:[o.properties[p],u.properties[p]]},r+"/properties/"+p);o.properties[p]=c,this.exitParents(c)}else o.properties[p]=u.properties[p];void 0!==u.items&&(o.items=o.items||{},o.items=this.mergeAllOf({allOf:[o.items,u.items]},r+"/items")),void 0!==u.required&&(o.required=(o.required||[]).concat(u.required)),o=tslib_1.__assign(tslib_1.__assign({},u),o),l&&(o.parentRefs.push(l),void 0===o.title&&utils_2.isNamedDefinition(l))}return o}}),Object.defineProperty(e.prototype,"findDerived",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var r={},t=this.definition.components&&this.definition.components.schemas||{};for(var i in t){var n=this.deref(t[i]);void 0!==n.allOf&&n.allOf.find((function(r){return void 0!==r.$ref&&e.indexOf(r.$ref)>-1}))&&(r["#/components/schemas/"+i]=[n["x-discriminator-value"]||i])}return r}}),Object.defineProperty(e.prototype,"exitParents",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var r=0,t=e.parentRefs||[];r<t.length;r++){var i=t[r];this.exitRef({$ref:i})}}}),Object.defineProperty(e.prototype,"hoistOneOfs",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var r=this;if(void 0===e.allOf)return e;for(var t=e.allOf,i=function(e){var i=t[e];if(Array.isArray(i.oneOf)){var n=t.slice(0,e),o=t.slice(e+1);return{value:{oneOf:i.oneOf.map((function(e){var t=r.mergeAllOf({allOf:tslib_1.__spreadArrays(n,[e],o)});return r.exitParents(t),t}))}}}},n=0;n<t.length;n++){var o=i(n);if("object"==typeof o)return o.value}return e}}),e}();exports.OpenAPIParser=OpenAPIParser;
//# sourceMappingURL=OpenAPIParser.js.map