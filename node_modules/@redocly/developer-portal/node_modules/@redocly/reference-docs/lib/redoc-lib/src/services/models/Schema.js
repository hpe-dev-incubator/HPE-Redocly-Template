"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),mobx_1=require("mobx"),Field_1=require("./Field"),utils_1=require("../../utils/"),Labels_1=require("../Labels"),SchemaModel=function(){function e(e,i,t,r,n,a,s){void 0===n&&(n=!1),void 0===s&&(s={}),Object.defineProperty(this,"parser",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"parent",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"deps",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"pointer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"displayType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typePrefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"title",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"externalDocs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isPrimitive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isCircular",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"displayFormat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nullable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"deprecated",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pattern",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"example",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"enum",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"default",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"readOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writeOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"constraints",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_fields",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oneOf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"oneOfType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"discriminatorProp",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"activeOneOf",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"rawSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extensions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"x-enumDescriptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"const",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"contentEncoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"contentMediaType",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),mobx_1.makeObservable(this),this.pointer=i.$ref||t||"",this.rawSchema=e.shallowDeref(i),this.schema=e.mergeAllOf(this.rawSchema,this.pointer,n),this.init(e,n),e.exitParents(this.schema),r.showExtensions&&(this.extensions=utils_1.extractExtensions(this.schema,r.showExtensions))}return Object.defineProperty(e.prototype,"activateOneOf",{enumerable:!1,configurable:!0,writable:!0,value:function(e){this.activeOneOf=e}}),Object.defineProperty(e.prototype,"fields",{get:function(){if(!this.isCircular)return this._fields||"object"!==this.type||(this._fields=buildFields(this.parser,this.schema,this.pointer,this.options,this,this.deps)),this._fields},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasCircularParent",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var i=this;if(this.parent){if(e.some((function(e){var t,r;if(!e)return!1;var n=i.parent;return n.pointer===e||(!!(null===(r=null===(t=n.schema.parentRefs)||void 0===t?void 0:t.some)||void 0===r?void 0:r.call(t,(function(i){return i===e})))||void 0)})))return!0;if(this.parent.hasCircularParent(e))return!0}return!1}}),Object.defineProperty(e.prototype,"init",{enumerable:!1,configurable:!0,writable:!0,value:function(i,t){var r=this,n=this.schema;if(this.isCircular=n["x-circular-ref"]||this.hasCircularParent(tslib_1.__spreadArrays([this.pointer],this.schema.parentRefs||[])),this.title=n.title||utils_1.isNamedDefinition(this.pointer)&&utils_1.JsonPointer.baseName(this.pointer)||"",this.description=n.description||"",this.type=n.type||utils_1.detectType(n),this.format=n.format,this.enum=n.enum||[],this["x-enumDescriptions"]=n["x-enumDescriptions"]||{},this.example=n.example,this.deprecated=!!n.deprecated,this.pattern=n.pattern,this.externalDocs=n.externalDocs,this.constraints=utils_1.humanizeConstraints(n),this.displayFormat=this.format,this.isPrimitive=utils_1.isPrimitiveType(n,this.type),this.default=n.default,this.readOnly=!!n.readOnly,this.writeOnly=!!n.writeOnly,this.const=n.const||"",this.contentEncoding=n.contentEncoding,this.contentMediaType=n.contentMediaType,(n.nullable||n["x-nullable"])&&(Array.isArray(this.type)&&!this.type.some((function(e){return null===e||"null"===e}))?this.type=tslib_1.__spreadArrays(this.type,["null"]):Array.isArray(this.type)||null===this.type&&"null"===this.type||(this.type=[this.type,"null"])),this.displayType=Array.isArray(this.type)?this.type.map((function(e){return null===e?"null":e})).join(" or "):this.type,!this.isCircular)if(t||void 0===getDiscriminator(n)){if(t&&Array.isArray(n.oneOf)&&n.oneOf.find((function(e){return e.$ref===r.pointer}))&&delete n.oneOf,void 0!==n.oneOf)return this.initOneOf(n.oneOf,i),this.oneOfType="One of",void(void 0!==n.anyOf&&console.warn("oneOf and anyOf are not supported on the same level. Skipping anyOf at "+this.pointer));if(void 0!==n.anyOf)return this.initOneOf(n.anyOf,i),void(this.oneOfType="Any of");if(("array"===this.type||Array.isArray(this.type))&&n.items&&(this.items=new e(i,n.items,this.pointer+"/items",this.options,!1,this,this.deps),this.displayType=utils_1.pluralizeType(this.items.displayType),this.displayFormat=this.items.format,this.typePrefix=this.items.typePrefix+Labels_1.l("arrayOf"),this.title=this.title||this.items.title,this.isPrimitive=this.items.isPrimitive,void 0===this.example&&void 0!==this.items.example&&(this.example=[this.items.example]),this.items.isPrimitive&&(this.enum=this.items.enum),Array.isArray(this.type))){var a=this.type.filter((function(e){return"array"!==e}));a.length&&(this.displayType+=" or "+a.join(" or "))}this.enum.length&&this.options.sortEnumValuesAlphabetically&&this.enum.sort()}else this.initDiscriminator(n,i)}}),Object.defineProperty(e.prototype,"initOneOf",{enumerable:!1,configurable:!0,writable:!0,value:function(i,t){var r=this;if(this.oneOf=i.map((function(i,n){var a=t.deref(i,!1,!0),s=t.mergeAllOf(a,r.pointer+"/oneOf/"+n),l=utils_1.isNamedDefinition(i.$ref)&&!s.title?utils_1.JsonPointer.baseName(i.$ref):""+(s.title||"")+(s.const&&JSON.stringify(s.const)||""),o=new e(t,tslib_1.__assign(tslib_1.__assign({},s),{title:l,allOf:[tslib_1.__assign(tslib_1.__assign({},r.schema),{oneOf:void 0,anyOf:void 0})]}),r.pointer+"/oneOf/"+n,r.options,!1,r.parent,tslib_1.__assign(tslib_1.__assign({},r.deps),{parentFieldFullPath:r.deps.parentFieldFullPath?r.deps.parentFieldFullPath+r.options.deepLinkSeparator+n:n.toString()}));return t.exitRef(i),t.exitParents(s),o})),this.options.simpleOneOfTypeLabel){var n=collectUniqueOneOfTypesDeep(this);this.displayType=n.join(" or ")}else this.displayType=this.oneOf.map((function(e){var i=e.typePrefix+(e.title?e.title+" ("+e.displayType+")":e.displayType);return i.indexOf(" or ")>-1&&(i="("+i+")"),i})).join(" or ")}}),Object.defineProperty(e.prototype,"initDiscriminator",{enumerable:!1,configurable:!0,writable:!0,value:function(i,t){var r=this,n=getDiscriminator(i);this.discriminatorProp=n.propertyName;var a=t.findDerived(tslib_1.__spreadArrays(i.parentRefs||[],[this.pointer]));if(i.oneOf)for(var s=0,l=i.oneOf;s<l.length;s++){var o=l[s];if(void 0!==o.$ref){var u=utils_1.JsonPointer.baseName(o.$ref);a[o.$ref]=u}}var p=n.mapping||{},b=n["x-explicitMappingOnly"]||!1;0===Object.keys(p).length&&(b=!1);var f={};for(var d in p){var c=p[d];Array.isArray(f[c])?f[c].push(d):f[c]=[d]}for(var h=b?tslib_1.__assign({},f):tslib_1.__assign(tslib_1.__assign({},a),f),y=[],m=0,v=Object.keys(h);m<v.length;m++){var O=h[c=v[m]];if(Array.isArray(O))for(var _=0,g=O;_<g.length;_++){var P=g[_];y.push({$ref:c,name:P})}else y.push({$ref:c,name:O})}var w=Object.keys(p);0!==w.length&&(y=y.sort((function(e,i){var t=w.indexOf(e.name),r=w.indexOf(i.name);return t<0&&r<0?e.name.localeCompare(i.name):t<0?1:r<0?-1:t-r}))),this.oneOf=y.map((function(i,n){var a=i.$ref,s=i.name,l=new e(t,t.byRef(a),a,r.options,!0,r.parent,tslib_1.__assign(tslib_1.__assign({},r.deps),{parentFieldFullPath:r.deps.parentFieldFullPath?r.deps.parentFieldFullPath+r.options.deepLinkSeparator+n:n.toString()}));return l.title=s,l}))}}),tslib_1.__decorate([mobx_1.observable],e.prototype,"activeOneOf",void 0),tslib_1.__decorate([mobx_1.action],e.prototype,"activateOneOf",null),e}();function buildFields(e,i,t,r,n,a){var s=i.properties||{},l=i.additionalProperties,o=i.default||{},u=Object.keys(s||[]).map((function(l){var u=s[l];u||(console.warn('Field "'+l+'" is invalid, skipping.\n Field must be an object but got '+typeof u+' at "'+t+'"'),u={});var p=void 0!==i.required&&i.required.indexOf(l)>-1;return new Field_1.FieldModel(e,{name:l,required:p,schema:tslib_1.__assign(tslib_1.__assign({},u),{default:void 0===u.default?o[l]:u.default})},t+"/properties/"+l,r,n,a)}));return r.sortPropsAlphabetically&&(u=utils_1.sortByField(u,"name")),r.requiredPropsFirst&&(u=utils_1.sortByRequired(u,r.sortPropsAlphabetically?void 0:i.required)),"object"!=typeof l&&!0!==l||u.push(new Field_1.FieldModel(e,{name:("object"==typeof l&&l["x-additionalPropertiesName"]||"property name").concat("*"),required:!1,schema:!0===l?{}:l,kind:"additionalProperties"},t+"/additionalProperties",r,n,a)),u}function getDiscriminator(e){return e.discriminator||e["x-discriminator"]}function collectUniqueOneOfTypesDeep(e){var i=new Set;return function e(t){for(var r=0,n=t.oneOf||[];r<n.length;r++){var a=n[r];a.oneOf?e(a):a.type&&i.add(a.type)}}(e),Array.from(i.values())}exports.SchemaModel=SchemaModel;
//# sourceMappingURL=Schema.js.map