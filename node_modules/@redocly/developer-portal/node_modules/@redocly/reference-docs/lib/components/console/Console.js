"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),React=tslib_1.__importStar(require("react")),informed_1=require("informed"),mobx_react_1=require("mobx-react"),utils_1=require("../../utils"),query_string_1=require("query-string"),styled_components_1=require("./styled.components"),ServerDropdown_1=require("./ServerDropdown"),OperationParameters_1=require("./OperationParameters"),ActionPanel_1=require("./ActionPanel"),ResponsePanel_1=require("./ResponsePanel"),RequestBody_1=require("./RequestBody"),ConsoleBadges_1=require("./ConsoleBadges"),AuthPanel_1=require("./AuthPanel"),services_1=require("../../services"),swagger_client_1=tslib_1.__importDefault(require("swagger-client")),redoc_lib_1=require("../../redoc-lib"),helper_1=require("../../redoc-lib/src/components/helper"),Labels_1=require("../../redoc-lib/src/services/Labels"),styled_components_2=tslib_1.__importDefault(require("../../redoc-lib/src/styled-components")),Panel_1=require("../Panel"),OAuth2_1=require("../../services/OAuth2"),PanelBody_1=require("../Panel/PanelBody"),utils_2=require("./utils");function normalizeUrlProtocol(e){return e.startsWith("//")?"https:"+e:e}var flexColumn={flex:1,display:"flex",flexDirection:"column"},Console=function(e){function t(t){var r=e.call(this,t)||this;return Object.defineProperty(r,"formApi",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(r,"setFormApi",{enumerable:!0,configurable:!0,writable:!0,value:function(e){r.formApi=e,setTimeout((function(){r.setState({form:r.formApi.getState()})}),0)}}),Object.defineProperty(r,"handleChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){r.setState({form:e}),utils_2.updateStorage(e)}}),Object.defineProperty(r,"handleTabChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){r.setState({activeTab:e})}}),Object.defineProperty(r,"handleServerChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){r.setState({server:e})}}),Object.defineProperty(r,"handleExecute",{enumerable:!0,configurable:!0,writable:!0,value:function(){return tslib_1.__awaiter(r,void 0,void 0,(function(){var e,t,r,n,o,a,s,i,l,c,u,d,p,_,h,m,b,v,f,y,g,P,R,q,S,w,C,E,x,A,I,O=this;return tslib_1.__generator(this,(function(k){switch(k.label){case 0:if(e=this.props,t=e.store,r=e.operation,this.formApi.submitForm(),n=this.formApi.getState(),o=n.values,n.invalid)return this.setState({shaking:!0}),setTimeout((function(){return O.setState({shaking:!1})}),1e3),null===(w=null===(S=null==t?void 0:t.options.events)||void 0===S?void 0:S.tryItSent)||void 0===w||w.call(S,{eventType:services_1.AnalyticsEventType.TryItSent,resource:"Redocly_OperationTryIt",action:"ValidationFailed",operationId:r.operationId,operationPath:r.path,operationHttpVerb:r.httpVerb,operationSummary:r.description}),[2];if(a=this.props.operation.requestBody,s=a&&a.content&&a.content.active&&a.content.active.name||"",i=o.body,/json/.test(s))try{i=JSON.parse(i)}catch(e){console.error(e)}if(this.setState({loading:!0}),l=t.dereferencedRawSpec,!(c=utils_1.get(l,["paths",r.path,(r.httpVerb||"").toLowerCase(),"servers"])||utils_1.get(l,["paths",r.path,"servers"])||utils_1.get(l,["servers"])))throw console.error("Servers are not specified in your OpenAPI file. You can't use Try It Out console without specifying servers. If you use OpenAPI 2, make sure you configured host and basepath"),new Error("Servers are not specified");u=c.find((function(e){return O.state.server.url.endsWith(e.url.endsWith("/")?e.url.substring(0,e.url.length-1):e.url)})),d=Date.now(),p=!!window.document.documentMode,o.auth?(h=Object.keys(o.auth)[0],_=tslib_1.__assign(tslib_1.__assign({},l),{components:tslib_1.__assign(tslib_1.__assign({},l.components),{securitySchemes:tslib_1.__assign(tslib_1.__assign({},l.components.securitySchemes),(q={},q[h]=tslib_1.__assign(tslib_1.__assign({},l.components.securitySchemes[h]),{type:"openIdConnect"===l.components.securitySchemes[h].type?"oauth2":l.components.securitySchemes[h].type}),q))})})):_=tslib_1.__assign({},l),(m=t.options.corsProxyUrl)&&l.servers&&l.servers.length&&(_.servers=l.servers.map((function(e){return{url:m+normalizeUrlProtocol(e.url),description:e.description}}))),b=(null===(E=null===(C=null==a?void 0:a.content)||void 0===C?void 0:C.active)||void 0===E?void 0:E.name)||null,v="application/x-www-form-urlencoded"===b?query_string_1.parse(i):i,k.label=1;case 1:return k.trys.push([1,5,8,9]),f={userFetch:p&&require("cross-fetch").fetch,server:m?m+normalizeUrlProtocol(u.url):u.url,serverVariables:this.state.server.variables,spec:_,pathName:r.path,method:r.httpVerb,parameters:tslib_1.__assign(tslib_1.__assign(tslib_1.__assign(tslib_1.__assign({},o.path),o.query),o.header),o.cookie),securities:{authorized:o.auth},requestBody:v,requestContentType:b,responseContentType:(null===(x=o.header)||void 0===x?void 0:x.Accept)||null,requestInterceptor:t.options.requestInterceptor&&function(e){var n,o;return null===(o=(n=t.options).requestInterceptor)||void 0===o?void 0:o.call(n,e,r)}||void 0},[4,swagger_client_1.default.execute(f)];case 2:return(y=k.sent())&&y.data instanceof Blob?(g=y,[4,y.data.text()]):[3,4];case 3:g.data=k.sent(),k.label=4;case 4:return this.setState({response:y,error:void 0}),[3,9];case 5:return(P=k.sent())&&P.response&&P.response.data instanceof Blob?(R=P.response,[4,P.response.data.text()]):[3,7];case 6:R.data=k.sent(),k.label=7;case 7:return this.setState({response:void 0,error:P}),[3,9];case 8:return this.setState({loading:!1,activeTab:1,time:Date.now()-d}),null===(I=null===(A=null==t?void 0:t.options.events)||void 0===A?void 0:A.tryItSent)||void 0===I||I.call(A,{eventType:services_1.AnalyticsEventType.TryItSent,resource:"Redocly_OperationTryIt",action:"Sent",operationId:r.operationId,operationPath:r.path,operationHttpVerb:r.httpVerb,operationSummary:r.description}),[7];case 9:return[2]}}))}))}}),Object.defineProperty(r,"validateBody",{enumerable:!0,configurable:!0,writable:!0,value:function(){}}),r.state={form:{values:{path:utils_2.getParameters(t.operation.parameters,"path"),cookie:utils_2.getParameters(t.operation.parameters,"cookie"),header:utils_2.getParameters(t.operation.parameters,"header"),query:utils_2.getParameters(t.operation.parameters,"query")}},shaking:!1,loading:!1,activeTab:0,server:{}},r}return tslib_1.__extends(t,e),Object.defineProperty(t.prototype,"componentDidMount",{enumerable:!1,configurable:!0,writable:!0,value:function(){return tslib_1.__awaiter(this,void 0,void 0,(function(){var e,t,r,n,o;return tslib_1.__generator(this,(function(a){switch(a.label){case 0:return e=this.props,t=e.store,r=e.specIdx,n=e.operation,[4,t.dereferenceSpecForTryIt(r||0,n)];case 1:return o=a.sent(),this.setState({resolvedRawSpec:o}),this.formApi.setValues({}),[2]}}))}))}}),Object.defineProperty(t.prototype,"componentDidUpdate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){e.operation!==this.props.operation&&this.setState({response:void 0,error:void 0,activeTab:0})}}),Object.defineProperty(t.prototype,"render",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.props,t=e.operation,r=e.className,n=e.rootElement,o=this.state,a=o.shaking,s=o.activeTab,i=o.form,l=o.response,c=o.loading,u=o.error,d=!(!l&&!u);return React.createElement(ConsoleWrapHook,{shaking:a,className:r,rootElement:n},React.createElement(Panel_1.CodeHeader,null,React.createElement(ConsoleBadges_1.ConsoleBadges,{active:s,hasResponse:d,onChange:this.handleTabChange}),React.createElement(styled_components_1.CloseButton,{onClick:this.props.onClose}," âœ• ")),React.createElement(styled_components_1.ConsoleBody,{hidden:0!==s},this.renderRequest()),React.createElement(styled_components_1.ConsoleBody,{hidden:1!==s},this.renderResponse()),React.createElement(ActionPanel_1.ActionPanel,{hasResponse:d,params:i.values&&tslib_1.__assign({},i.values),operation:t,loading:c,execute:this.handleExecute}))}}),Object.defineProperty(t.prototype,"renderRequest",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t=this.props,r=t.operation,n=t.store,o=this.state,a=o.form,s=o.resolvedRawSpec,i=o.server,l=a.errors||{},c=l.path||l.cookie||l.header||l.query,u=s&&redoc_lib_1.JsonPointer.get(s,r.pointer),d=a.values&&a.values.auth&&Object.keys(a.values.auth)[0];d&&a.values.auth[d]||(d=void 0),!d||void 0===a.values.auth[d].token&&void 0===a.values.auth[d].client_id&&void 0===a.values.auth[d].client_secret||a.values.auth[d].token&&a.values.auth[d].token.access_token||(d=void 0),d&&null!=a.values.auth[d].username&&(a.values.auth[d].username&&a.values.auth[d].password||(d=void 0));var p=r.parameters||[],_=null===(e=null==n?void 0:n.options.hooks)||void 0===e?void 0:e.ReplaceTryItAuthPanel;return s?React.createElement(React.Fragment,null,React.createElement(informed_1.Form,{onChange:this.handleChange,getApi:this.setFormApi,style:tslib_1.__assign(tslib_1.__assign({},flexColumn),{margin:0})},React.createElement(Panel_1.Accordion,{initialActiveIdx:r.security.length&&d?1:0},r.security.length&&React.createElement(TryItPanel,{header:Labels_1.l("tryItAuth"),renderChildrenHidden:!0,error:!d&&!!l.auth,success:!!d},_?React.createElement(AuthPanelHook,{field:"auth",validate:AuthPanel_1.requiredValidator},(function(e){return React.createElement(helper_1.RenderHook,{Hook:_,props:{server:i,operation:r,onChange:e,OAuth2:OAuth2_1.OAuth2}})})):React.createElement(AuthPanel_1.AuthPanel,{formApi:this.formApi,form:a,operation:r,activeServer:i.url,authCorsProxyUrl:n.options.authCorsProxyUrl}))||null,r.requestBody&&React.createElement(TryItPanel,{header:Labels_1.l("tryItBody"),renderChildrenHidden:!0,error:!!l.body},React.createElement(RequestBody_1.RequestBody,{validate:this.validateBody,console:this,body:r.requestBody,id:r.id,resolvedBody:u.requestBody}))||null,p.length&&React.createElement(TryItPanel,{header:Labels_1.l("tryItParameters"),error:c,renderChildrenHidden:!0},React.createElement(OperationParameters_1.OperationParameters,{operation:r,values:a.values,errors:a.errors||{}}))||null)),React.createElement(ServerDropdown_1.ServerChooser,{operation:r,onChange:this.handleServerChange})):"Loading..."}}),Object.defineProperty(t.prototype,"renderResponse",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e=this.state,t=e.response,r=e.error,n=e.time;return React.createElement(ResponsePanel_1.ResponsePanel,{response:t,error:r,time:n})}}),t=tslib_1.__decorate([mobx_react_1.observer],t)}(React.Component);function ConsoleWrapHook(e){var t=e.shaking,r=e.className,n=e.children,o=e.rootElement,a=utils_1.useDimensions(o)[0];return React.createElement(styled_components_1.ConsoleWrap,{shaking:t,className:r,"data-cy":"console",fullWidth:null==a?void 0:a.width},n)}function AuthPanelHook(e){var t=informed_1.useField(tslib_1.__assign({},e)),r=t.fieldApi,n=t.render,o=t.userProps,a=r.setValue,s=o.children;return n(React.createElement(React.Fragment,null,s(a)))}function TryItPanel(e){return React.createElement(StyledTryItPanel,tslib_1.__assign({},e,{header:function(t){var r=t.toggle,n=t.expanded;return React.createElement(Panel_1.Header,{onClick:r,isExpanded:n},React.createElement(Panel_1.Trigger,null,React.createElement(Panel_1.Title,null,e.header),React.createElement(redoc_lib_1.ShelfIcon,{direction:n?"down":"right"})),e.error&&React.createElement(redoc_lib_1.CrossIcon,{size:"14px",color:"#ff908b"})||null,e.success&&React.createElement(redoc_lib_1.LockIcon,{size:"14px",color:"#56ff26"})||null)}}))}exports.Console=Console;var templateObject_1,StyledTryItPanel=styled_components_2.default(Panel_1.Panel)(templateObject_1||(templateObject_1=tslib_1.__makeTemplateObject(["\n  "," {\n    color: white;\n    border: 1px solid ",";\n    padding: 10px;\n  }\n\n  "," path {\n    fill: white;\n  }\n\n  "," {\n    padding: 15px 10px;\n    background-color: #3e4c59;\n    border: 1px solid ",";\n    border-top: 0;\n  }\n"],["\n  "," {\n    color: white;\n    border: 1px solid ",";\n    padding: 10px;\n  }\n\n  "," path {\n    fill: white;\n  }\n\n  "," {\n    padding: 15px 10px;\n    background-color: #3e4c59;\n    border: 1px solid ",";\n    border-top: 0;\n  }\n"])),Panel_1.Header,(function(e){return e.error?"#ff908b":"#89949f"}),redoc_lib_1.ShelfIcon,PanelBody_1.PanelBody,(function(e){return e.error?"#ff908b":"#89949f"}));
//# sourceMappingURL=Console.js.map