"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),React=tslib_1.__importStar(require("react")),redoc_lib_1=require("../redoc-lib"),ProStore_1=require("../services/ProStore"),slugify_1=tslib_1.__importDefault(require("slugify")),fast_deep_equal_1=tslib_1.__importDefault(require("fast-deep-equal")),services_1=require("../services");function fixSpec(e){for(var t=e.components&&e.components.securitySchemes||{},r=0,n=Object.keys(t);r<n.length;r++){var i=t[n[r]];i["x-type"]&&(i.type=i["x-type"]),i["x-scheme"]&&(i.scheme=i["x-scheme"])}}function loadMany(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){switch(t.label){case 0:return[4,loadSpecs(e||[])];case 1:return t.sent(),[2,e]}}))}))}function loadSingle(e,t,r){return tslib_1.__awaiter(this,void 0,void 0,(function(){var n,i,s,a;return tslib_1.__generator(this,(function(o){switch(o.label){case 0:if(!(null==r?void 0:r.skipBundleAndConvert))return[3,1];if(!e)throw new Error('spec must be specified when using "skipBundleAndConvert"');return n=e,[3,3];case 1:return[4,redoc_lib_1.loadAndBundleDefinition(e||t)];case 2:n=o.sent(),o.label=3;case 3:if(!(i=null==r?void 0:r.unstable_externalDescription))return[3,8];o.label=4;case 4:return o.trys.push([4,7,,8]),[4,fetch(i)];case 5:return[4,o.sent().text()];case 6:return s=o.sent(),n.info.description=s,[3,8];case 7:return a=o.sent(),console.warn("Failed to load external description from "+i+": "+a.message),[3,8];case 8:try{fixSpec(n)}catch(e){}return[2,n]}}))}))}function loadAndBundleSpecOrMd(e,t){return e.endsWith(".md")?redoc_lib_1.loadAndBundleDefinition({openapi:"3.0.0",info:{title:t||"",version:"1.0",description:{$ref:e}},paths:{}}):redoc_lib_1.loadAndBundleDefinition(e)}function loadSpecs(e){return tslib_1.__awaiter(this,void 0,void 0,(function(){var t,r,n,i,s,a,o,u,c,l,d;return tslib_1.__generator(this,(function(f){switch(f.label){case 0:if(!Array.isArray(e))return[3,8];t=0,r=e,f.label=1;case 1:return t<r.length?((n=r[t]).id=n.id||slugify_1.default(n.title),n.url?[4,loadAndBundleSpecOrMd(n.url,n.title)]:[3,3]):[3,8];case 2:return d=f.sent(),n.definition=d,[3,7];case 3:i=0,s=n.items||[],f.label=4;case 4:return i<s.length?(a=s[i]).url?[4,loadAndBundleSpecOrMd(a.url,n.title)]:[3,6]:[3,7];case 5:d=f.sent(),a.definition=d,f.label=6;case 6:return i++,[3,4];case 7:return t++,[3,1];case 8:if(o=e.versions,!Array.isArray(o))return[3,12];u=0,c=o,f.label=9;case 9:return u<c.length?(l=c[u]).url?[4,loadAndBundleSpecOrMd(l.url)]:[3,11]:[3,12];case 10:d=f.sent(),l.spec=d,f.label=11;case 11:return u++,[3,9];case 12:return[2]}}))}))}function useDeepCompareMemoize(e){var t=React.useRef(),r=React.useRef(0);return fast_deep_equal_1.default(e,t.current)||(t.current=e,r.current+=1),[r.current]}exports.Provider=(_a=React.createContext(void 0)).Provider,exports.Consumer=_a.Consumer,exports.ProStoreProvider=function(e){var t=e.definitions,r=e.options,n=e.definitionUrl,i=e.definition,s=e.activeItemId,a=e.activeSampleLanguage,o=e.activeDeepLink,u=e.children,c=React.useState()[1],l=React.useState(!0),d=l[0],f=l[1],_=React.useState(null),p=_[0],v=_[1];React.useEffect((function(){!function(){tslib_1.__awaiter(this,void 0,void 0,(function(){var e,s,a;return tslib_1.__generator(this,(function(o){switch(o.label){case 0:f(!0),o.label=1;case 1:return o.trys.push([1,6,,7]),e=v,t?[4,loadMany(t)]:[3,3];case 2:return s=o.sent(),[3,5];case 3:return[4,loadSingle(i,n,r)];case 4:s=o.sent(),o.label=5;case 5:return e.apply(void 0,[s]),[3,7];case 6:return a=o.sent(),c((function(){throw a})),[3,7];case 7:return[2]}}))}))}()}),[t,i,n]);var b=React.useMemo((function(){if(p)return new ProStore_1.ProStore(p,n,r)}),useDeepCompareMemoize([p,r]));return React.useEffect((function(){if(b)return f(!1),function(){return b.dispose()}}),[b]),React.useEffect((function(){var e;if(b&&s){var t=(null==s?void 0:s.split(b.options.deepLinkPrefix)[0])||(null===(e=b.menu.flatItems[b.menu.activeItemIdx])||void 0===e?void 0:e.id),r=b.menu.flatItems.find((function(e){return e.id===t})),n=o?t+b.options.deepLinkPrefix+o:void 0;n&&b.menu.history instanceof services_1.FakeHistoryService&&b.menu.history.replaceForField(n),b.menu.activateAndScroll(r,!0,!1,n)}}),[s,o,b]),React.useEffect((function(){b&&a&&b.setActiveSampleLanguage(a)}),[a,b]),u({loading:d,store:b})},exports.loadSpecs=loadSpecs;
//# sourceMappingURL=StoreProvider.js.map