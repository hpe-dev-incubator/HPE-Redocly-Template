"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),React=tslib_1.__importStar(require("react")),redoc_lib_1=require("../../redoc-lib"),LinearProgress_1=require("../common/LinearProgress"),form_1=require("../common/form"),OAuth2_1=require("../../services/OAuth2"),utils_1=require("../../utils"),Scope_1=tslib_1.__importDefault(require("./Scope")),shared_1=require("../shared"),TextField_1=require("../common/TextField"),utils_2=require("./utils");function requiredValidator(e){if(!e)return"Field is required"}var OAuth2Flow=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return Object.defineProperty(t,"state",{enumerable:!0,configurable:!0,writable:!0,value:{error:null,loading:!1}}),Object.defineProperty(t,"clearToken",{enumerable:!0,configurable:!0,writable:!0,value:function(){t.props.formApi.setValue("auth."+t.props.id+".token","")}}),t}return tslib_1.__extends(t,e),Object.defineProperty(t.prototype,"values",{get:function(){return this.props.form.values&&this.props.form.values.auth&&this.props.form.values.auth[this.props.id]||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"errors",{get:function(){return this.props.form.errors&&this.props.form.errors.auth&&this.props.form.errors.auth[this.props.id]||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"handleAuthorize",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=this;if(e){this.props.formApi.validate();var r=this.props,l=r.flow,i=r.id,a=r.tokenUrl,o=r.authCorsProxyUrl;if(this.values.client_id&&("authorizationCode"!==l||this.values.client_secret)){this.setState({loading:!0,error:null});var n=o?o+utils_2.normalizeUrlProtocol(e):e,s=o&&a?o+utils_2.normalizeUrlProtocol(a):a,u=this.props.formApi.getValue("auth."+i+".scopes"),c={authorizationUrl:n.startsWith("http")?n:this.props.server+n,clientId:this.values.client_id,scopes:u,redirectUri:this.context.oAuth2RedirectURI,routingBasePath:this.context.routingBasePath,successCallback:function(e){t.props.formApi.setValue("auth."+t.props.id+".token",e),t.setState({loading:!1,error:null})},errorCallback:function(e){t.setState({loading:!1,error:(null==e?void 0:e.message)||"Failed to retrieve the access token"})}};"implicit"===l&&OAuth2_1.OAuth2.authorizeImplicit(c),"authorizationCode"===l&&OAuth2_1.OAuth2.authorizeAuthorizationCode(tslib_1.__assign(tslib_1.__assign({},c),{tokenUrl:(null==s?void 0:s.startsWith("http"))?s:this.props.server+s,clientSecret:this.values.client_secret}))}}}}),Object.defineProperty(t.prototype,"handleLogout",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.clearToken(),this.setState({error:null})}}),Object.defineProperty(t.prototype,"handleCancel",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.setState({loading:!1,error:null}),OAuth2_1.OAuth2.clearRedirectData(this.props.flow)}}),Object.defineProperty(t.prototype,"render",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,r=this,l=this.state,i=l.error,a=l.loading,o=this.props,n=o.id,s=o.scopes,u=o.authorizationUrl,c=o.flow;if(!u)return React.createElement(form_1.FormError,null,"No flow info");var p=utils_1.fromStorage("auth."+n+".token");p=p?JSON.parse(p):"";var d=utils_1.getSecurityDetailsOptions(n,"client_id"),m={field:"auth."+n+".client_id",fullWidth:!0,initialValue:utils_1.fromStorage("auth."+n+".client_id")||this.props.clientId,initValue:utils_1.fromStorage("auth."+n+".client_id")||this.props.clientId,placeholder:"Your OAuth2 app Client ID",validate:requiredValidator,validateOnBlur:!0,validateOnChange:!0};return React.createElement("div",null,React.createElement(form_1.FormWrapper,null,React.createElement(form_1.FormControl,null,React.createElement(form_1.FormLabel,null," Client ID: "),d?React.createElement(TextField_1.FormDropdown,tslib_1.__assign({},m,{options:d})):React.createElement(TextField_1.FormTextField,tslib_1.__assign({},m))),"authorizationCode"===c&&React.createElement(form_1.FormControl,null,React.createElement(form_1.FormLabel,null,"Client Secret:"),React.createElement(TextField_1.FormTextField,{type:"password",fullWidth:!0,field:"auth."+n+".client_secret",initialValue:utils_1.fromStorage("auth."+n+".client_secret"),validate:requiredValidator,validateOnBlur:!0,validateOnChange:!0})),React.createElement(TextField_1.FormTextField,{fullWidth:!0,field:"auth."+n+".token",type:"hidden",initialValue:p,validate:requiredValidator}),React.createElement(Scope_1.default,{id:n,scopes:s}),this.values.token&&this.values.token.access_token?React.createElement(form_1.FormControl,null,React.createElement(form_1.FormLabel,null," Access Token: "),React.createElement(TextField_1.TextField,{disabled:!0,type:"password",fullWidth:!0,value:this.values.token.access_token})):null),React.createElement(ButtonsWrapper,null,this.values.token&&this.values.token.access_token?React.createElement(shared_1.Button,{fullWidth:!0,onClick:function(){r.handleLogout()}},"Log out"):React.createElement(React.Fragment,null,a?React.createElement(React.Fragment,null,React.createElement(shared_1.Button,{fullWidth:!0,onClick:function(){r.handleCancel()}},"Cancel"),React.createElement(LinearProgress_1.LinearProgress,null)):React.createElement(shared_1.Button,{fullWidth:!0,disabled:(null===(t=null===(e=this.props)||void 0===e?void 0:e.formApi)||void 0===t?void 0:t.getTouched("auth."+n+".client_id"))&&!this.values.client_id,onClick:function(){r.handleAuthorize(u)}},"Authorize"))),a||i||!this.values.token||!this.values.token.access_token&&React.createElement(form_1.FormWrapper,null,React.createElement(form_1.FormControl,null,a?React.createElement(form_1.FormWarning,null,"Please, finish your authorization flow or cancel authorization."):i?React.createElement(React.Fragment,null,React.createElement(OriginalErrorMessage,null,React.createElement(form_1.FormError,null,i))):this.values.token&&this.values.token.access_token?null:React.createElement(form_1.FormWarning,null," No Access Token. Please, Authorize. "))))}}),Object.defineProperty(t,"contextType",{enumerable:!0,configurable:!0,writable:!0,value:redoc_lib_1.OptionsContext}),t}(React.Component);exports.OAuth2Flow=OAuth2Flow;var templateObject_1,templateObject_2,OriginalErrorMessage=redoc_lib_1.styled.div(templateObject_1||(templateObject_1=tslib_1.__makeTemplateObject(["\n  font-family: monospace;\n  margin-top: 10px;\n  line-height: 1;\n  padding-left: 10px;\n  border-left: 1px solid gray;\n"],["\n  font-family: monospace;\n  margin-top: 10px;\n  line-height: 1;\n  padding-left: 10px;\n  border-left: 1px solid gray;\n"]))),ButtonsWrapper=redoc_lib_1.styled.div(templateObject_2||(templateObject_2=tslib_1.__makeTemplateObject(["\n  margin-bottom: 15px;\n"],["\n  margin-bottom: 15px;\n"])));
//# sourceMappingURL=OAuth2Flow.js.map