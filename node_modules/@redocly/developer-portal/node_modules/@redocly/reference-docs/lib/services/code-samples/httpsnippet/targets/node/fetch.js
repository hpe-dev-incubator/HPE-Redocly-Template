"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),stringify_object_1=tslib_1.__importDefault(require("stringify-object")),code_builder_1=require("../../helpers/code-builder"),code_helpers_1=require("../../helpers/code-helpers"),constants_1=require("../../helpers/constants"),utils_1=require("../../../../utils"),__1=require("../.."),printPathVariablesCodeLines=function(e,t){var a=e.pathParameters;return Object.keys(a).forEach((function(e){var r=a[e]||"YOUR_"+e+"_PARAMETER";t.push("const "+t.var(e,constants_1.VariableType.PATH)+" = '%s';",r)}))};function getUrl(e,t){var a=e.url,r=void 0===a?"":a,n=e.pathParameters,i=void 0===n?{}:n;return code_helpers_1.parseUrlIntoOperands(r,i).map((function(e){return"variable"===e.type?"${"+t.var(e.name,constants_1.VariableType.PATH)+"}":e.value})).join("")}var handler=function(e,t,a){var r,n,i,s,o,d=a.target,l=a.client,p=Object.assign({indent:"  "},t),c=!1,h=new code_builder_1.CodeBuilder({indentation:p.indent,variablesPrefix:p.variablesPrefix,capitalize:!0,lang:constants_1.Lang.NODEJS});p.withComments&&addComments(h),p.withImports&&(h.push("const fetch = require('node-fetch');"),h.blank());var u={method:e.method.toUpperCase()};Object.keys(e.headersObj).length&&(u.headers=e.headersObj);var m=!1;if(null===(r=e.securityOAuth2ExtraCalls)||void 0===r?void 0:r.length){var f=new __1.HTTPSnippet(null===(n=e.securityOAuth2ExtraCalls)||void 0===n?void 0:n[0]).convert(d,l,tslib_1.__assign(tslib_1.__assign({},p),{withImports:!1,withComments:!1,variablesPrefix:"oAuth2"}));h.push(f),h.blank(),u.headers=u.headers||{},u.headers.Authorization="'Bearer ' + oAuth2Data.access_token",m=!0}var b=Object.getOwnPropertyNames(e.queryObj).length;if(b&&h.push("const "+h.var("query")+" = new URLSearchParams("+stringify_object_1.default(e.queryObj,{indent:p.indent,inlineCharacterLimit:25})+").toString();").blank(),e.postData)switch(utils_1.normalizeMimeType(e.postData.mimeType)){case"application/x-www-form-urlencoded":u.body=e.postData.paramsObj?"new URLSearchParams("+h.var("formData")+").toString()":e.postData.text,e.postData.paramsObj&&h.push("const "+h.var("formData")+" = "+code_helpers_1.addIndentation(stringify_object_1.default(e.postData.paramsObj,{indent:p.indent,inlineCharacterLimit:25}),{level:0,firstLine:!1})+";").blank();break;case"application/json":e.postData.jsonObj&&(u.body="JSON.stringify("+code_helpers_1.addIndentation(stringify_object_1.default(e.postData.jsonObj,{indent:p.indent,inlineCharacterLimit:25}),{level:1,firstLine:!1})+")");break;case"multipart/form-data":(null===(i=null==u?void 0:u.headers)||void 0===i?void 0:i["Content-Type"])&&(null===(s=u.headers)||void 0===s||delete s["Content-Type"]),p.withImports&&h.unshift("const FormData = require('form-data');"),h.push("const "+h.var("form")+" = new FormData();"),e.postData.params.forEach((function(e){e.fileName||e.fileName||e.contentType?e.fileName&&(c=!0,h.blank(),h.push(h.var("form")+".append('\" + param.name + \"', fs.createReadStream('\" + param.fileName + \"'));")):h.push("form.append('"+e.name+"','"+e.value+"');")})),u.body=h.var("form"),h.blank();break;default:e.postData.text&&(u.body="`"+code_helpers_1.addIndentation(e.postData.text,{level:2,indent:p.indent,firstLine:!1}).trim()+"`")}if(e.cookies.length){var _="";e.cookies.forEach((function(e){_=_+encodeURIComponent(e.name)+"="+encodeURIComponent(e.value)+"; "})),_=_.trim(),u.headers||(u.headers={}),u.headers.cookie=_}e.basicAuth&&(u.headers=u.headers||{},u.headers.Authorization="'Basic ' + Buffer.from('<username>:<password>').toString('base64')",m=!0),c&&p.withImports&&h.unshift("const fs = require('fs');");var v=u.headers&&u.headers.Accept&&"application/json"===utils_1.normalizeMimeType(u.headers.Accept)||"application/json"===utils_1.normalizeMimeType(null===(o=e.postData)||void 0===o?void 0:o.mimeType);return printPathVariablesCodeLines(e,h),h.push("const "+h.var("resp")+" = await fetch(").push(1,"`"+getUrl(e,h)+(b?"?${"+h.var("query")+"}":"")+"`,").push(code_helpers_1.addIndentation(stringify_object_1.default(u,{indent:p.indent,inlineCharacterLimit:25,transform:code_helpers_1.getPreserveTransformer({body:!0,authorizationHeader:m})}),{level:1,indent:p.indent})).push(");").blank().push("const "+h.var("data")+" = await "+h.var("resp")+"."+(v?"json()":"text()")+";").push("console.log("+h.var("data")+");"),h.join().replace(/"fs\.createReadStream\(\\"(.+)\\"\)"/,'fs.createReadStream("$1")')};function addComments(e){e.push("/**"),e.push(" * Requires Node.js >= 14"),e.push(" *"),e.push(' * Requires module "node-fetch" >= 2.6.1'),e.push(" * See here for installation details:"),e.push(" *   https://www.npmjs.com/package/node-fetch"),e.push(" */"),e.blank()}exports.info={key:"fetch",title:"Fetch",link:"https://github.com/bitinn/node-fetch",description:"Simplified HTTP node-fetch client"},exports.default=handler;
//# sourceMappingURL=fetch.js.map