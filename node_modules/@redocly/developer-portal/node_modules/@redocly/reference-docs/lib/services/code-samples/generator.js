"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tslib_1=require("tslib"),httpsnippet_1=require("./httpsnippet"),redoc_lib_1=require("../../redoc-lib"),query_string_1=require("query-string"),Sampler=tslib_1.__importStar(require("openapi-sampler")),utils_1=require("../../utils"),utils_2=require("../utils");function mapOperationToHAR(e,t){var a,r,i,n,s,l,o,u=t.exampleName,p=void 0===u?"":u,c=t.skipOptionalParameters,d=void 0!==c&&c,m=t.withOAuth2Call,h=void 0!==m&&m,_=t.spec,v=t.generatedPayloadSamplesMaxDepth,f=void 0===v?8:v,g=getSecurityData(null===(a=e.security)||void 0===a?void 0:a[0],h),y=g.securityHeaders,O=g.securityCookies,C=g.securityQueries,S=g.securityOAuth2ExtraCalls,w=g.basicAuth,T=null===(i=null===(r=e.requestBody)||void 0===r?void 0:r.content)||void 0===i?void 0:i.active,b={skipNonRequired:d,skipReadOnly:!0,maxSampleDepth:f},x=!1,A=e.parameters.filter((function(e){return"header"===e.in})).filter((function(e){return!(d&&!e.required)})).map((function(e){return{name:e.name,value:utils_1.getParameterValue("header",e.name)||redoc_lib_1.serializeParameterValue(e,Sampler.sample(e.schema.rawSchema,b,_))}})).map((function(e){return(null==T?void 0:T.name)&&"content-type"===e.name.toLowerCase()&&(x=!0,e.value=T.name),e})).concat(y);!x&&(null==T?void 0:T.name)&&A.unshift({name:"Content-Type",value:null==T?void 0:T.name});var E=e.parameters.filter((function(e){return"cookie"===e.in})).filter((function(e){return!(d&&!e.required)})).map((function(e){return query_string_1.parse(redoc_lib_1.serializeParameterValue(e,Sampler.sample(e.schema.rawSchema,b,_)))})).reduce((function(e,t){for(var a=0,r=Object.entries(t);a<r.length;a++){var i=r[a],n=i[0],s=i[1];e.push({name:n,value:String(s)})}return e}),[]).concat(O),P=e.parameters.filter((function(e){return"query"===e.in})).filter((function(e){return!(d&&!e.required)})).map((function(e){return query_string_1.parse(redoc_lib_1.serializeParameterValue(e,Sampler.sample(e.schema.rawSchema,b,_)))})).reduce((function(e,t){for(var a=0,r=Object.entries(t);a<r.length;a++){var i=r[a],n=i[0],s=i[1];e.push({name:n,value:String(s)})}return e}),[]).concat(C),q=(null===(n=e.servers[0])||void 0===n?void 0:n.url.replace(/\/$/,""))+"/"+e.path.replace(/^\//,""),k=e.parameters.filter((function(e){return"path"===e.in})).reduce((function(e,t){var a=t.in,r=t.name;return e[r]=utils_1.getParameterValue(a,r),e}),{}),H=(null===(l=null===(s=null==T?void 0:T.examples)||void 0===s?void 0:s[p])||void 0===l?void 0:l.value)||(null===(o=Object.values((null==T?void 0:T.examples)||{})[0])||void 0===o?void 0:o.value),D=null==T?void 0:T.name.toLowerCase(),R=utils_2.isSameMime(D,"application/x-www-form-urlencoded")||utils_2.isSameMime(D,"multipart/form-data"),z="application/json"===utils_2.normalizeMimeType(D)?JSON.stringify(H):String(H||"");!z&&R&&(z=(null==T?void 0:T.schema)?query_string_1.stringify(Sampler.sample(T.schema.rawSchema,b,_)):"");var j=R?objectToHarParams(query_string_1.parse(z)):[],N=z?{mimeType:(null==T?void 0:T.name)||"",text:z,params:j}:void 0;return{method:e.httpVerb,url:q,httpVersion:"HTTP/1.1",cookies:E,headers:A,queryString:P,postData:N,headersSize:-1,bodySize:-1,securityOAuth2ExtraCalls:S,basicAuth:w,pathParameters:k}}var defaultOptions={withImports:!0,withComments:!1},langToSnippetConfig={curl:{code:"shell",defaultTarget:"curl",defaultOptions:tslib_1.__assign(tslib_1.__assign({},defaultOptions),{short:!0})},JavaScript:{code:"javascript",defaultTarget:"fetch",defaultOptions:tslib_1.__assign(tslib_1.__assign({},defaultOptions),{withImports:!1})},"Node.js":{code:"node",defaultTarget:"fetch",defaultOptions:tslib_1.__assign({},defaultOptions)},Python:{code:"python",defaultTarget:"requests",defaultOptions:tslib_1.__assign({},defaultOptions)},"Java8+Apache":{code:"java8",defaultTarget:"apachehttp",defaultOptions:tslib_1.__assign({},defaultOptions)},Java:{code:"java",defaultTarget:"httpclient",defaultOptions:tslib_1.__assign({},defaultOptions)},"C#":{code:"csharp",defaultTarget:"httpclient",defaultOptions:tslib_1.__assign({},defaultOptions)},Go:{code:"go",defaultTarget:"http.DefaultClient",defaultOptions:tslib_1.__assign({},defaultOptions)}};function getCodeSample(e){var t=e.lang,a=e.operation,r=e.exampleName,i=e.options,n=void 0===i?{}:i;try{var s=n,l=mapOperationToHAR(a,{exampleName:r,skipOptionalParameters:s.skipOptionalParameters,withOAuth2Call:s.withOAuth2Call,spec:s.spec,generatedPayloadSamplesMaxDepth:s.generatedPayloadSamplesMaxDepth}),o=new httpsnippet_1.HTTPSnippet(l);return langToSnippetConfig[t]?o.convert(langToSnippetConfig[t].code,langToSnippetConfig[t].defaultTarget,tslib_1.__assign(tslib_1.__assign({},langToSnippetConfig[t].defaultOptions),n)):"Language is not supported."}catch(e){return console.error(e),"Failed to generate code sample."}}function getSecurityData(e,t){for(var a,r,i,n,s={securityHeaders:[],securityCookies:[],securityQueries:[],securityOAuth2ExtraCalls:[],basicAuth:void 0},l=0,o=(null==e?void 0:e.schemes)||[];l<o.length;l++){var u=o[l],p=utils_1.getSecurityDetails(u.id);switch(u.type){case"openIdConnect":null===(a=s.securityHeaders)||void 0===a||a.push({name:"Authorization",value:"Bearer <YOUR_TOKEN_HERE>"});break;case"oauth2":var c=p.token?(p.token.token_type||"Bearer")+" "+p.token.access_token:"Bearer <YOUR_TOKEN_HERE>";u.flows.clientCredentials&&t?s.securityOAuth2ExtraCalls.push(getOAuth2ClientCredsCallHar(u.flows.clientCredentials,u.scopes,p)):u.flows.password&&t&&s.securityOAuth2ExtraCalls.push(getOAuth2PasswordCallHar(u.flows.password,u.scopes,p)),null===(r=s.securityHeaders)||void 0===r||r.push({name:"Authorization",value:c});break;case"apiKey":var d=p.raw||"YOUR_API_KEY_HERE";"header"===u.in&&(null===(i=s.securityHeaders)||void 0===i||i.push({name:u.name,value:d})),"cookie"===u.in&&s.securityCookies.push({name:u.name,value:d}),"query"===u.in&&s.securityQueries.push({name:u.name,value:d});break;case"http":"basic"===u.scheme?s.basicAuth={username:p.username||"<username>",password:p.password||"<password>"}:null===(n=s.securityHeaders)||void 0===n||n.push({name:"Authorization",value:capitalizeFirst(u.scheme||"bearer")+" <YOUR_"+(u.bearerFormat||"TOKEN")+"_HERE>"})}}return s}function getOAuth2PasswordCallHar(e,t,a){return{method:"POST",url:e.tokenUrl,httpVersion:"HTTP/1.1",headers:[{name:"Content-Type",value:"application/x-www-form-urlencoded"},{name:"Accept",value:"application/json"}],queryString:[],postData:{mimeType:"application/x-www-form-urlencoded",text:"",params:[{name:"grant_type",value:"password"},{name:"client_id",value:a.client_id||"YOUR_CLIENT_ID"},{name:"client_secret",value:a.client_secret||"YOUR_CLIENT_SECRET"},{name:"username",value:a.username||"<username>"},{name:"password",value:a.password||"<password>"},t.length?{name:"scope",value:t.join(" ")}:void 0].filter(isDefined)},cookies:[],headersSize:-1,bodySize:-1,securityOAuth2ExtraCalls:[]}}function getOAuth2ClientCredsCallHar(e,t,a){return{method:"POST",url:e.tokenUrl,httpVersion:"HTTP/1.1",headers:[{name:"Content-Type",value:"application/x-www-form-urlencoded"},{name:"Accept",value:"application/json"}],queryString:[],postData:{mimeType:"application/x-www-form-urlencoded",text:"",params:[{name:"grant_type",value:"client_credentials"},{name:"client_id",value:a.client_id||"YOUR_CLIENT_ID"},{name:"client_secret",value:a.client_secret||"YOUR_CLIENT_SECRET"},t.length?{name:"scope",value:t.join(" ")}:void 0].filter(isDefined)},cookies:[],headersSize:-1,bodySize:-1,securityOAuth2ExtraCalls:[]}}function objectToHarParams(e){for(var t=[],a=0,r=Object.entries(e);a<r.length;a++){var i=r[a],n=i[0],s=i[1];t.push({name:n,value:String(s)})}return t}function isDefined(e){return void 0!==e}function capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}exports.getCodeSample=getCodeSample,exports.isDefined=isDefined,exports.capitalizeFirst=capitalizeFirst;
//# sourceMappingURL=generator.js.map