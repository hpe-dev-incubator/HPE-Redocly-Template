const visit=require("unist-util-visit"),isRelativeUrl=require(`is-relative-url`),path=require("path"),slugify=require("slugify"),remarkCustomBlocks=require(`remark-admonitions`),{replaceEnv,getEnv}=require("../../utils"),{isYamlBasedPage}=require("../gatsby-source-redocly-filesystem/utils"),{DEFAULT_ALERT_ICONS}=require("../../constants");module.exports=({markdownAST:a,markdownNode:b,getNode:c,getNodes:d,pathPrefix:e=""},f)=>{e.endsWith("/")&&(e=e.substr(0,e.length-1));let g=[],h=[];visit(a,"html",(a,b,c)=>{isCodeSnippetNode(a)&&g.push({node:a,parent:c})}),visit(a,"link",a=>{a.url=replaceEnv(a.url,f.envVariablesAllowedClientSide)});const i=d().filter(a=>"ContentItem"===a.internal.type);visit(a,`link`,a=>{const[d,f]=a.url.split("#");if(isRelativeUrl(d)&&`File`===c(b.parent).internal.type){const g=d.startsWith("/")?d.substr(1):path.posix.join(c(b.parent).relativeDirectory,d),h=f?"#"+f:"",[j,k]=isYamlBasedPage(g)?[`${g}${h}`,""]:[g,h],l=i.find(a=>a.pageId===j);l&&(a.url=e+l.link+k)}}),g.forEach(({node:a,parent:b})=>{let c=h[h.length-1]||{nodes:[]},d=c.nodes[c.nodes.length-1];d?isSiblings(d,a,b)?c.nodes.push(a):h.push({parent:b,nodes:[a]}):h.push({parent:b,nodes:[a]})});const j="Mdx"===b.internal.type;h.forEach(a=>{if(1<a.nodes.length){const b=createSnippetsGroupNode(a,j);replaceCodeSnippets(a,b)}}),j&&(visit(a,"heading",function(a){const b=a.children&&a.children.find(a=>"link"===a.type&&null===a.title);!b||b.data&&b.data.hChildren&&1===b.data.hChildren.length&&"raw"===b.data.hChildren[0].type&&(b.children=b.data.hChildren,delete b.data.hChildren,b.children[0].type="html",b.children[0].value=b.children[0].value.replace("fill-rule","fillRule").replace("class","className"),b.data.hProperties.className=b.data.hProperties.class,delete b.data.hProperties.class)}),visit(a,"html",function(a){a.lang?a.value=`<div dangerouslySetInnerHTML={{__html: ${JSON.stringify(a.value)}}} />`:(a.value=a.value.replace(/to\s*=\s*("[^"]*?"|{"[^"]*?"}|{'[^']*?'})/gi,(a,d)=>{const e=d.replace(/^({"|{'|"|)/,"").replace(/("}|'}|"|)$/,"");if(e.match(/(^https?:\/\/|^[\/#])/i))return a;if(isRelativeUrl(e)&&`File`===c(b.parent).internal.type){const a=e.startsWith("/")?e.substr(1):path.posix.join(c(b.parent).relativeDirectory,e),d=i.find(b=>b.pageId===a);if(d)return`to={'${d.link}'}`}return a}),-1<a.value.indexOf("class=\"gatsby-resp-image")&&(a.value=`<span dangerouslySetInnerHTML={{__html: ${JSON.stringify(a.value)}}} />`))}))},module.exports.setParserPlugins=a=>{function b(a,b,d){const e=b.match(/^{{\s*process\.env\.([a-zA-Z_][a-zA-Z0-9_]*)\s*}}/),f=e&&getEnv(e[1],c);if(f)return!!d||a(e[0])({type:"text",value:f})}const c=a.envVariablesAllowedClientSide;return b.notInLink=!0,b.locator=(a,b)=>Math.min(a.indexOf(`{{`,b),a.indexOf(`_`,b)),[function(){const a=this.Parser,c=a.prototype.inlineTokenizers,d=a.prototype.inlineMethods;c["replace-env"]=b,d.splice(d.indexOf("escape")+1,0,"replace-env")},[remarkCustomBlocks,{customTypes:{warning:{svg:"<i/>"},success:{svg:"<i/>"},danger:{svg:"<i/>"},attention:{svg:"<i/>"},info:"attention"}}]]};function isCodeSnippetNode(a){return"html"===a.type&&a.lang}function isSiblings(a,b,c){if(!a||!b||!c)return!1;const d=1===Math.abs(c.children.indexOf(a)-c.children.indexOf(b)),e=Math.abs(a.position.end.line-b.position.start.line);return d&&(1===e||2==e)}function createSnippetsGroupNode(a,b){const c=a.nodes[0],d=a.nodes[a.nodes.length-1],e=[],f=[],g=new Set;a.nodes.forEach((a,b)=>{const c=a.details||a.lang;let d=slugify(c);g.has(d)&&(d=`${d}-${b}`),g.add(d),e.push(`<span class="tab-header ${0===b?"active":""}" data-lang="${a.lang}" data-snippet-id="${d}">${c}</span>`),f.push(`<div class="tab-content ${0===b?"active":""}" data-lang="${a.lang}" data-snippet-id="${d}">${a.value}</div>`)});const h=`
    <div class="snippets-tabs-headers">
      ${e.map(a=>a).join("")}
    </div>
    <div class="snippets-tabs-contents">
      ${f.map(a=>a).join("")}
    </div>`;return{type:"html",value:`
      <div ${b?"className":"class"}="code-snippets-tabs" ${b?`dangerouslySetInnerHTML={{__html:  ${JSON.stringify(h)} }} />`:`>${h}</div>`}
    `,position:{indent:c.position.indent,start:c.position.start,end:d.position.end}}}function replaceCodeSnippets(a,b){const{parent:c,nodes:d}=a,e=c.children.indexOf(d[0]),f=c.children.indexOf(d[a.nodes.length-1]);c.children=[...c.children.slice(0,e),b,...c.children.slice(f+1)]}