const path=require("path"),fs=require("fs-extra"),{writeFileSync}=require("fs"),chalk=require("chalk"),grayMatter=require("gray-matter"),isRelativeUrl=require(`is-relative-url`),{slash}=require("gatsby-core-utils"),{safeLoad}=require("js-yaml"),{replaceEnvDeep,sanitizeDefinitionId}=require("../../utils"),{monkeyPatchReporter}=require("../../../cli/reporter"),RBAC=require("./rbac"),{getClientRoutes,saveClientSideRoutesInBuild}=require("./client-only-routes"),{onCreateWebpackConfig}=require("./webpack/config"),{createResolvers}=require("./resolvers"),{REDOCLY_CONFIG_DIR}=require("../../../engine/constants"),{createPath,contentDigest,isYamlBasedPage,isAllowedMdxFile,isAllowedDataFile,extractFirstMdHeading,CONFIG_FILE_NAME,SIDEBARS_FILE_NAME,readYaml,normalizeGatsbyPage,isAllowedFileName}=require("./utils"),{getOrCreateRedocStoreById:getRedocStoreById,definitionFileToId,updateSpecCacheByIdAndPath}=require("./oas/cache"),{updatePagesInfo,updatePagesInfoCache}=require("./pages/cache"),{configWatcher}=require("./watcher"),{createConfigNode,createSidebarNodes}=require("./config-nodes"),{REDOC_OVERVIEW_ITEM_ID,PAGE_TYPES}=require("../../constants"),{getLastModifiedForFile,getLastModifiedForFileNode}=require("./utils");exports.onCreateWebpackConfig=onCreateWebpackConfig,exports.createResolvers=createResolvers;let RBACConfig=RBAC.RBACConfig;function createContentItem(a,b={},c,d=""){b=replaceEnvDeep(b),b.description=b.description||"",b.label=b.label||b.title||"",b.title=b.title||"",b.redocStoreStr=b.redocStoreStr||"",b.redocItemId=b.redocItemId||"",b.redocMenuItems=b.redocMenuItems||[],b.redocInfoPageId=b.redocInfoPageId||"",b.redocInfoPageLink=b.redocInfoPageLink||"",b.redocHasInfoPage=!!b.redocHasInfoPage,b.redocHasSecurityDefinitions=!!b.redocHasSecurityDefinitions,b.redocPagination=b.redocPagination||"",b.httpVerb=b.httpVerb||null,b.requestLogin=b.requestLogin||!1,b.showNextButton=b.showNextButton;const e=b.permission||RBAC.GUEST_PERMISSION;b.customTemplate=b.customTemplate||"",b.customDataString=b.customData?JSON.stringify(b.customData):"",b.matchPath=b.matchPath||"",b.excludeFromSearch=!!b.excludeFromSearch,b.sourcePath=c&&c.absolutePath;let f,g,h;if(c){const a=b.isDefaultApiVersion?"":null==b.apiVersionId?"":"@"+b.apiVersionId;h=b.path?slash(normalizeGatsbyPage(b.path)):slash(createPath(c.relativePath)),f=slash(path.join(h,null==b.apiVersionId?"":"/"+b.apiVersionId,d)),g=slash(c.relativePath+(d?"#"+d:"")+a),f.endsWith("/index")&&(f=f.substring(0,f.length-6),""===f&&(f="/")),f=f.endsWith("/")?f:f+"/"}else f=b.path,g="custom-page_"+f;return{id:(c&&c.id||"custom_page")+d+"__redocly content"+(b.redirect?" redirect":"")+f,pageId:g,link:f,baseLink:h,type:a,data:b,permission:e,sourcePath:c&&c.absolutePath,parent:c&&c.id||null,internal:{type:"ContentItem",owner:"",contentDigest:contentDigest({type:a,data:b,suffix:d})},children:[]}}exports.onCreateNode=async(a,{getSiteConfig:b,configPath:c})=>{async function d(a){const b=l(a.parent),{relativePath:d}=b;if(a.frontmatter&&!0===a.frontmatter.exclude)return;const e=RBAC.getDirectoryPermission(c,path.dirname(path.resolve(c,d))),f=a.frontmatter&&a.frontmatter.permission?a.frontmatter.permission:void 0,g=createContentItem(PAGE_TYPES.markdown,{...a.frontmatter,lastModified:await getLastModifiedForFileNode(b,c),permission:f||e||r,customData:a.frontmatter,title:a.frontmatter.title||extractFirstMdHeading(a.rawMarkdownBody)},b);return await q(g),o(g),n({node:a,name:"contentId",value:g.id}),void p({parent:b,child:g})}function e(a,b){if(!a)return a;const c=a.split("/");return"item"===b&&"operation"===c[2]?a.split("/").slice(2).join("/"):a}async function f(d,f,h){const i=h.definitionId,j=s[i],k=h.id;if(!j)return void m.panicOnBuild(`Invalid definitionId "${i}" at ${t}`);const l=isRelativeUrl(j),n=l?path.resolve(c,j):j,u=f.settings&&f.settings.pagination||"item";if(!["item","section","none"].includes(u))throw new Error(`Wrong pagination value "${u}": should be "item" or "section" or "none"`);const{redocStoreStr:v,redocStore:w}=await getRedocStoreById(i,n,{...a,getSiteConfig:b,configPath:c},{...(f.settings||{}),pagination:u});if(!w)return void m.panicOnBuild(`Failed to load definition "${i}" at ${t}`);const x=RBAC.getDirectoryPermission(c,path.dirname(path.resolve(c,d.relativePath))),y=f.permission||x||r;f={...f,apiVersionId:1<f.apiVersions.length?k:void 0,isDefaultApiVersion:h.isDefault,redocStoreStr:v,permission:y,lastModified:l?await getLastModifiedForFile(n,c):await getLastModifiedForFileNode(d,c)};const z=w.menu.flatItems,A=[],B=f.settings||{};let C;const D=!B.hideInfoDescription||!B.hideInfoSection||"none"===u,E=!B.hideInfoSection;if(D){const a=f.label||w.definition.info&&w.definition.info.title||"Overview",b=f.title||a;if(C=createContentItem(PAGE_TYPES.referenceDocsOverview,{...f,title:b,label:a,redocItemId:REDOC_OVERVIEW_ITEM_ID,redocHasInfoPage:E,redocHasSecurityDefinitions:w.definition.parser.hasSecurityDefinitions,redocPagination:u},d,REDOC_OVERVIEW_ITEM_ID),"none"===u){const a=new RegExp(`\\/${REDOC_OVERVIEW_ITEM_ID}\\/?`);C.link=C.link.replace(a,"/")}f.path?C.link=slash(normalizeGatsbyPage(f.path)):"index.page.yaml"===d.relativePath&&(C.link="/"),A.push(C),await q(C)}if("none"!==u)for(let a of z){if(a.operationDefinition&&a.operationDefinition["x-private"])continue;if("group"===a.type||"section"===a.type)continue;if("tag"===a.type&&!a.description&&"item"===u)continue;if("operation"===a.type&&"section"===u)continue;const b={title:a.name,label:a.name,description:a.description,httpVerb:a.isWebhook?"hook":a.httpVerb,redocItemId:a.id,redocInfoPageLink:C&&C.link,redocHasSecurityDefinitions:w.definition.parser.hasSecurityDefinitions,redocPagination:u},c=createContentItem(PAGE_TYPES.referenceDocsPage,{...f,...b},d,e(a.id,u));A.push(c)}f.path?A[0].link=slash(normalizeGatsbyPage(f.path)):"index.page.yaml"===d.relativePath&&(A[0].link="/");for(let a=0;a<A.length;a++){const b=A[a].data;b.redocPrevLink=A[a-1]&&A[a-1].link,b.redocPrevLabel=A[a-1]&&A[a-1].data.label,b.redocNextLink=A[a+1]&&A[a+1].link,b.redocNextLabel=A[a+1]&&A[a+1].data.label,o(A[a]),await q(A[a]),p({parent:d,child:A[a]})}const F=h.isDefault?"":null==h.id?"":"@"+h.id,G=d.relativePath+F,H=g(w.menu.items,A,{pagination:u,parentPageId:A[0].pageId,redocInfoPageLink:A[0].link,apiVersionId:h.id,isDefaultApiVersion:h.isDefault,permission:y}),I=createContentItem(PAGE_TYPES.referenceDocsContainerPage,{redirect:!0,...f,title:C&&C.data.title||w.definition.info.title,label:f.nav_label||C&&C.data.title||w.definition.info.title,redocMenuItems:H,redocInfoPageId:E?C&&C.pageId:void 0,redocPagination:u},d,e(A[0].data.redocItemId,u));return I.pageId=G,I.link=A[0].link,o(I),await q(I),void p({parent:d,child:I})}function g(a,b,c){const{pagination:d,parentPageId:e,redocInfoPageLink:f}=c;return a.flatMap(a=>{const h=a.id;if("group"===a.type)return[{separator:a.name,...c,parentPageId:void 0},...(a.items&&a.items.length?g(a.items,b,c):void 0)];if("section"===a.type){const d=b.find(a=>a.data.redocItemId===h);return{label:a.name,link:f+"#"+h,redocFakePage:!(d&&d.pageId),pages:a.items&&a.items.length?g(a.items,b,c):void 0,parentPageId:e,...c}}if("tag"===a.type){const i=b.find(a=>a.data.redocItemId===h);return{label:a.name,page:i&&i.pageId,link:i||"item"===d&&!a.description?void 0:f+"#"+a.id,pages:a.items&&a.items.length?g(a.items,b,{...c,parentPageId:i&&i.pageId||e,redocInfoPageLink:i&&i.link||f}):void 0,parentPageId:e,redocFakePage:!(i&&i.pageId),...c}}if("operation"===a.type){const d=b.find(a=>a.data.redocItemId===h);return{label:a.name,httpVerb:a.isWebhook?"hook":a.httpVerb,page:d&&d.pageId,redocFakePage:!(d&&d.pageId),link:d?void 0:f+"#"+h,parentPageId:e,...c}}return{label:a.name}})}async function h(a){const b=fs.readFileSync(a.absolutePath).toString(),{data:d}=grayMatter(b);if(d&&!0===d.exclude)return;const e=RBAC.getDirectoryPermission(c,path.dirname(path.resolve(c,a.relativePath))),f=d&&d.permission?d.permission:void 0,g=createContentItem(PAGE_TYPES.mdx,{...d,permission:f||e||r,customData:d,lastModified:await getLastModifiedForFileNode(a,c)},a);return await q(g),o(g),void p({parent:a,child:g})}async function i(a){const{onDataFile:b}=getCustomCreators({configPath:c,reporter:m});if(!b)return;const d=RBAC.getDirectoryPermission(c,path.dirname(path.resolve(c,a.absolutePath)));b(a,{reporter:m,createTemplatePage:async({meta:b,data:e,template:f,path:g})=>{const h=createContentItem(PAGE_TYPES.dataTemplate,{...b,customTemplate:path.resolve(path.join(c,EXTENSIONS_FOLDER),f),customData:e,path:g,permission:d||r},a);await q(h),o(h),p({parent:a,child:h})}})}const{node:j,actions:k,getNode:l,reporter:m}=a,{createNodeField:n,createNode:o,createParentChildLink:p}=k,q=async d=>updatePagesInfo(d,a,{getSiteConfig:b,configPath:c}),{defaultRbacPermission:r,oasDefinitions:s}=b(),t=chalk.blue(j.relativePath);switch(j.internal.type){case"MarkdownRemark":const a=l(j.parent||"");if(!a||!isAllowedFileName(a.relativePath))return!1;await d(j);break;case"File":if(!isAllowedFileName(j.absolutePath))return!1;if(isYamlBasedPage(j.absolutePath)){let a=await readYaml(j.absolutePath);if("redoc"==a.type&&m.warn(`type: "redoc" is deprecated, update it to type: "reference-docs" at ${chalk.blue(j.relativePath)}`),"redoc"!==a.type&&"reference-docs"!==a.type)return void m.panicOnBuild(`Unknown page "type" for ${t}: "${a.type}. You should specify\n`+chalk.blue(`  type: reference-docs`));const b=a.definitionId,c=a.versions;if(!b&&!c)return void m.panicOnBuild(`You must specify "definitionId" or "versions" when using type: "${a.type}" at ${t}`);if(b&&c)return void m.panicOnBuild(`"definitionId" and "versions" are mutually exclusive at ${t}`);if(c&&!Array.isArray(c))return void m.panicOnBuild(`"versions" must be an array at ${t}`);const d=b?[{definitionId:b,isDefault:!0,title:b,id:b}]:c.filter(a=>!!a.definitionId||(m.panicOnBuild(`"definitionId" is not specified for every version at ${t}`),!1)).map(a=>({id:a.id||a.definitionId,title:a.title||a.id||a.definitionId,...a}));d.some(a=>a.isDefault)||(d[0].isDefault=!0);for(const b of d)await f(j,{...a,version:void 0,apiVersions:d},b)}isAllowedMdxFile(j.absolutePath)&&(await h(j)),isAllowedDataFile(j.absolutePath)&&(await i(j));}};const EXTENSIONS_FOLDER="_extensions";function getCustomCreators({configPath:a,reporter:b}){if(fs.existsSync(path.join(a,EXTENSIONS_FOLDER,"custom-pages.js"))){const c=require(path.join(a,EXTENSIONS_FOLDER,"custom-pages.js")),d="function"==typeof c.onDataFile?c.onDataFile:null,e="function"==typeof c.createPages?c.createPages:null;return d||e||b.panicOnBuild("Creator function must export \"onDataFile\" or \"createPages\" function"),{onDataFile:d,createPages:e,configFile:path.join(a,EXTENSIONS_FOLDER,"custom-pages.js")}}return{onDataFile:null,createPages:null,configFile:null}}exports.onPostBootstrap=({getNodesByType:a})=>{updatePagesInfoCache({getNodesByType:a})},exports.createPages=({getNodesByType:a})=>{updatePagesInfoCache({getNodesByType:a})};let configNodesReadyPromise;exports.sourceNodes=async(a,b)=>{monkeyPatchReporter(a.reporter);const{configPath:c,getSiteConfig:d}=b,{reporter:e,actions:{createNode:f}}=a,g={...a,...b},h=path.join(c,CONFIG_FILE_NAME),i=path.join(c,SIDEBARS_FILE_NAME);configWatcher.add([h,i]),configNodesReadyPromise=async function(){return await createConfigNode(h,g),await createSidebarNodes(i,a,c),!0}(),await configNodesReadyPromise,configWatcher.on(`change`,b=>{if(b===h)return void createConfigNode(h,g);if(b===i)return void createSidebarNodes(i,a,c);let d=definitionFileToId[b];d||(b=Object.keys(definitionFileToId).find(a=>b.startsWith(a))||"",d=definitionFileToId[b]),d&&updateSpecCacheByIdAndPath(d,b,g)});const j=async b=>updatePagesInfo(b,a,{getSiteConfig:d,configPath:c}),{createPages:k,configFile:l}=getCustomCreators({configPath:c,reporter:e});k&&(await k({reporter:e,createTemplatePage:async({meta:a,data:b,template:d,path:g})=>{g||e.panicOnBuild(`path argument is required in "createTemplatePage" at "${l}"`);const h=createContentItem(PAGE_TYPES.dataTemplate,{...a,customTemplate:path.resolve(path.join(c,EXTENSIONS_FOLDER),d),customData:b,path:g},void 0);await j(h),f(h)}}))},exports.onCreateBabelConfig=({actions:a})=>{a.setBabelPlugin({name:`@babel/plugin-proposal-object-rest-spread`})};let patchFs;try{patchFs=require("gatsby/node_modules/fs-extra")}catch(a){patchFs=require("fs-extra")}const origReadFile=patchFs.readFile;patchFs.readFile=async function(a,...b){if(a.endsWith(".mdx")){const c=await origReadFile(a,...b);return c+"\n\n<!-- graphql -->"}return origReadFile(a,...b)};function extractDefinitionIds(a){if(1===a.indexOf("definitionId"))return[];const b=/<\w[a-z0-9_]*[\s\n][^>]*?definitionId\s*=\s*(?:"([^"\n]*)"|{[\s\n]*"([^"\n]*)"[\s\n]*})/gim;let c,d=[];for(;null!==(c=b.exec(a));)d.push(c[1]||c[2]);return b.lastIndex===-Infinity&&console.log("Workaround to prevent regex inlining by babel-minify"),d}exports.onPostBuild=async({reporter:a,graphql:b},{publicDir:c,getSiteConfig:d,configPath:e})=>{const f=d(),g=path.join(e,RBAC.ROLES_FILE_NAME),h=fs.existsSync(g);if(f.auth||h){const d={auth:f.auth};let i;if(h){const a=safeLoad(fs.readFileSync(g,{encoding:"utf-8"})),d=await RBAC.queryData(b),h=d.sidebars.nodes.reduce((a,b)=>(a[b.name]=b,a),{}),{footer:j,nav:k}=d.siteConfig,l=d.pages.nodes,m=a&&a.defaultPermission?a.defaultPermission:f.defaultRbacPermission,n=RBAC.getDirectoriesPermissions(e,path.join(e,"static"),m),o={};for(const{link:a,permission:b}of l)o[`${a.slice(1)}index.html`]=b,o[`page-data${a}page-data.json`]=b;i={rbac:a,nav:k,footer:j,sidebars:h,apis:d.apis&&d.apis.map(a=>({...a,data:{...a.data,redocStoreStr:void 0}})),pages:{...n,...RBACConfig,...o}},RBAC.copyClaimsPreprocessor({config:f,configPath:e,publicDir:c})}const j=path.join(c,RBAC.AUTH_CONFIG_FILENAME);RBAC.saveSettings(j,{...d,...i},a),a.info(`Saved ${j}`),writeFileSync(path.join(__dirname,"../../.cache","rbacConfig.json"),JSON.stringify(RBACConfig))}const i=await getClientRoutes(b,a);a.info(`Client-only routes: ${JSON.stringify(i)}`);const j=path.join(c,path.join(REDOCLY_CONFIG_DIR,"client-only-routes.json"));await saveClientSideRoutesInBuild(j,i,a)},exports.preprocessSource=async function({filename:a,contents:b}){const c=path.extname(a),d=extractDefinitionIds(b),e=d.length&&d.map(a=>`__oasDef_${sanitizeDefinitionId(a)}:  oasDefinition(id: "${a}") { redocStoreStr }`).join("\n")||"";if(".mdx"===c){let a=b.match(/export (?:const|let) [a-zA-Z0-9_]+\s+=\s+graphql`((?:.|\r?\n)+?)`/);return a&&a[1]?`import { graphql } from 'gatsby';\nexport const pageQuery = graphql\`${a[1]}\`;`:`import {graphql} from 'gatsby';
export const pageQuery = graphql\`
  query ($pageId: String!) {
    contentItem(pageId: { eq: $pageId }) {
      data {
        disableLastModified
        enableToc
        tocMaxDepth
        requestLogin
        lastModified
      }
    }
    siteConfig {
      enableToc
      disableLastModified
      tocMaxDepth
    }
    ${e}
  }
\`;`}return null};