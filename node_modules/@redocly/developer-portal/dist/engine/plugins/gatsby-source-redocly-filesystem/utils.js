const fs=require("fs-extra"),crypto=require("crypto"),path=require("path"),slugify=require("slugify").default,jsYaml=require("js-yaml"),{slash}=require("gatsby-core-utils"),isRelativeUrl=require(`is-relative-url`),fetch=require("node-fetch").default,remark=require("remark"),chalk=require("chalk"),git=require("simple-git/promise"),throttle=require("lodash.throttle"),RBAC=require("./rbac"),{isChildOf}=require("../../utils"),YAML_PAGE_EXENSION=exports.YAML_PAGE_EXENSION=".page.yaml";exports.CONFIG_FILE_NAME="siteConfig.yaml",exports.SIDEBARS_FILE_NAME="sidebars.yaml";async function readFileAsync(a,b){return new Promise(function(c,d){fs.readFile(a,b,function(a,b){a?d(a):c(b)})})}exports.isYamlBasedPage=a=>a.endsWith(YAML_PAGE_EXENSION),exports.isAllowedMdxFile=a=>{const{ext:b,name:c}=path.parse(a);return!(c.startsWith("_")||c.startsWith("template-"))&&!(".mdx"!==b)},exports.isAllowedDataFile=a=>{const{ext:b,name:c}=path.parse(a);return!c.startsWith("_")&&[".yaml",".yml",".json"].includes(b)},exports.normalizeGatsbyPage=a=>a.startsWith("/")?a:"/"+a,exports.readYaml=async(a,b)=>{try{let c=isRelativeUrl(a)||/^[a-zA-Z]:\//.test(a)?await readFileAsync(a,"utf8"):await(await fetch(a)).text();return b&&(c=b(c)),jsYaml.load(c)}catch(a){throw a}},exports.contentDigest=a=>crypto.createHash("sha1").update(JSON.stringify(a)).digest("hex"),exports.createPath=a=>{if(!a)return"";a.endsWith(YAML_PAGE_EXENSION)&&(a=a.replace(new RegExp(`${YAML_PAGE_EXENSION}$`),""));const{dir:b,name:c}=path.parse(a);return"/"+slash(path.join(b,c)).split("/").map(a=>slugify(a).toLowerCase()).map(a=>a.toLowerCase()).join("/")},exports.relative=(a,b)=>a?path.relative(path.resolve(b),a):null,exports.extractFirstMdHeading=function(a){const b=remark().parse(a).children.find(a=>"heading"===a.type),c=b&&b.children[0].value;return c},exports.copyFile=function(a,{context:b,getNodesByType:c,getNodeAndSavePathDependency:d,pathPrefix:e,reporter:f},g,h){if(!a||!isRelativeUrl(a))return a;const i=path.resolve(g,a),j=c("File").find(a=>a.absolutePath===slash(i));if(!j)return f.warn(chalk.yellow(`Cannot find local file ${a}`)),null;const k=b?d(j.id,b.path):j,l=path.resolve(h,"static");if(isChildOf(i,l))return`${e}/${slash(path.relative(l,i))}`;const m=`${j.name}-${j.internal.contentDigest}${k.ext}`,n=path.join(process.cwd(),`public`,`static`,m);return RBAC.RBACConfig[path.relative(path.join(process.cwd(),`public`),n)]=RBAC.getDirectoryPermission(h,path.dirname(k.absolutePath)),fs.existsSync(n)||fs.copy(k.absolutePath,n,a=>{a&&f.panicOnBuild(`Error copying file from ${k.absolutePath} to ${n}`,a)}),`${e}/static/${m}`},exports.staticCopyFile=function(a,{reporter:b,pathPrefix:c},d,e){if(c=normalizePathPrefix(c),"/"===c&&(c=""),!a||!isRelativeUrl(a))return a;const f=path.resolve(d,a);if(!fs.existsSync(f))return b.warn(chalk.yellow(`Cannot find local file ${a}`)),null;const g=path.resolve(e,"static");if(isChildOf(f,g))return`${c}/${slash(path.relative(g,f))}`;const h=path.extname(f),i=exports.contentDigest(fs.readFileSync(f,"utf-8")),j=`${path.basename(f,h)}-${i}${h}`,k=path.join(process.cwd(),`public`,`static`,j);return RBAC.RBACConfig[path.relative(path.join(process.cwd(),`public`),k)]=RBAC.getDirectoryPermission(e,path.dirname(f)),fs.existsSync(k)||fs.copy(f,k,a=>{a&&b.panicOnBuild(`Error copying file from ${f} to ${k}`,a)}),`${c}/static/${j}`},exports.copyReferencedFiles=function a(b,c,d,e){if(!b)return b;const f=Array.isArray(b)?[]:{};for(let g of Object.keys(b))if("string"==typeof b[g]&&b[g]){const a=b[g].startsWith("/")?path.resolve(e,b[g].slice(1)):path.resolve(d,b[g]);if(fs.existsSync(a)&&fs.statSync(a).isFile(a)){if([".md",".mdx"].includes(path.extname(a))||a.endsWith(".page.yaml")){const b=c.getNodesByType("ContentItem").find(b=>b.sourcePath===a);f[g]=b&&b.link||f[g]}else f[g]=exports.copyFile(a,c,d,e)||f[g];f["original_"+g]=b[g]}else f[g]=b[g]}else f[g]="object"==typeof b[g]&&null!==b[g]?a(b[g],c,d,e):b[g];return f},exports.isAllowedFileName=a=>"readme.md"!==a.toLowerCase()&&!path.basename(a).startsWith("_");function normalizePathPrefix(a){return addLeadingSlash(removeTrailingSlash(a))}function removeTrailingSlash(a){return a.endsWith("/")?a.substring(0,a.length-1):a}function addLeadingSlash(a){return a.startsWith("/")?a:`/${a}`}async function gitStatus(a){return await git(a).silent().status()}const throttledGitStatus=throttle(gitStatus,{leading:!0});exports.getLastModifiedForFileNode=async function(a,b){const{absolutePath:c,modifiedTime:d}=a;return exports.getLastModifiedForFile(c,b,d)},exports.getLastModifiedForFile=async function(a,b,c){try{c=c||fs.statSync(a).mtime;const d=await throttledGitStatus(b),e=d.files.some(c=>slash(path.resolve(b,"..",c.path))===slash(a));if(e)return c;else{const d=await git(b).silent().log(["--",a]);return d.latest&&d.latest.date&&toISO(d.latest.date)||c}}catch(a){return c||null}};function toISO(a){return new Date(Date.parse(a)).toISOString()}